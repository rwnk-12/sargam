
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Srgam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif']
                    },
                    colors: {
                        'music-bg-base': '#09090b',
                        'music-bg-elevated': '#1c1c1e',
                        'music-bg-hover': '#27272a',
                        'music-bg-card': '#18181b',
                        'music-border': '#27272a',
                        'music-text-primary': '#fafafa',
                        'music-text-secondary': '#a1a1aa',
                        'music-accent': '#f5596d',
                        'music-accent-hover': '#f5596d',
                        'music-ring': '#f5596d',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --player-height: 72px;
            --bg-primary: #09090b;
            --bg-elevated: #1c1c1e;
            --bg-card: #18181b;
            --bg-hover: #27272a;
            --border-color: #27272a;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --accent-color: #f5596d;
            --accent-hover: #f5596d;
            --ring-color: #f5596d;
            --accent-gradient: linear-gradient(to right, #f5596d, #f5596d);
            --skeleton-bg: #202020;
            --skeleton-highlight: #333333;
            --lyrics-text-color: rgba(255, 255, 255, 0.7);
            --lyrics-active-color: var(--text-primary);
            --title-translate-x: 0px;
        }
        body { font-family: 'Inter', -apple-system, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; background-color: var(--bg-primary); color: var(--text-primary); }
        body.lyrics-view-active #app-wrapper,
        body.lyrics-view-active #player-bar,
        body.lyrics-view-active #mobile-player-container { display: none; }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; border: 3px solid var(--bg-primary); }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        html, body { height: 100%; overflow: hidden; }
        #main-content { padding-bottom: calc(var(--player-height) + 2rem); }
        .control-active { color: var(--accent-color) !important; }
        #play-pause-button, #lyrics-play-pause-button { background: var(--text-primary); color: var(--bg-elevated); }
        #play-pause-button:hover, #lyrics-play-pause-button:hover { transform: scale(1.05); }
        .control-slider { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; cursor: pointer; height: 12px; }
        .control-slider::-webkit-slider-runnable-track { width: 100%; height: 4px; border-radius: 4px; background: linear-gradient(to right, var(--progress-color, #fff) 0%, var(--progress-color, #fff) var(--progress-percent, 0%), #4f4f52 var(--progress-percent, 0%)); transition: all 0.2s ease; }
        .control-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -4px; height: 12px; width: 12px; background-color: #fff; border-radius: 50%; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .control-slider-wrapper:hover .control-slider::-webkit-slider-thumb { opacity: 1; }
        .control-slider-wrapper:hover .control-slider::-webkit-slider-runnable-track { background: var(--accent-gradient); }
        .skeleton { position: relative; overflow: hidden; background-color: var(--skeleton-bg); }
        .skeleton::before { content: ''; position: absolute; top: 0; left: -150%; width: 150%; height: 100%; background: linear-gradient(90deg, transparent, var(--skeleton-highlight), transparent); animation: skeleton-shine 2s infinite cubic-bezier(0.4, 0.0, 0.2, 1); }
        @keyframes skeleton-shine { 100% { left: 100%; } }
        #lyrics-view { display: none; }
        body.lyrics-view-active #lyrics-view { display: flex; flex-direction: column; }
        #lyrics-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background-color: rgba(0,0,0,0.5); }
        .lyrics-bg-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; filter: blur(40px) brightness(0.5); transform: scale(1.2); opacity: 0; transition: opacity 1s ease-in-out; }
        .lyrics-bg-image.loaded { opacity: 1; }
        #lyrics-content { position: relative; z-index: 101; width: 100%; flex-grow: 1; display: flex; align-items: center; color: white; padding: 2rem 4rem; overflow-y: auto; scroll-padding-bottom: 2rem; }
        #lyrics-meta-column { width: 30%; flex-shrink: 0; }
        #lyrics-container-wrapper { width: 70%; height: 100%; display: flex; flex-direction: column; overflow: hidden; padding-left: 1rem; }
        #lyrics-container { flex-grow: 1; overflow-y: auto; text-align: left; scroll-behavior: smooth; scroll-padding: 38% 0; -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%); mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%); }
        #lyrics-container::-webkit-scrollbar { display: none; }
        #lyrics-container { -ms-overflow-style: none;  scrollbar-width: none; }
        #lyrics-container::before, #lyrics-container::after { content: ''; display: block; height: 38%; }
        .lyrics-line { font-size: 2.3rem; font-weight: 673; line-height: 1.4; margin: 0 0 0.8em 0; color: var(--lyrics-text-color); transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1); cursor: pointer; opacity: 0.6; transform-origin: left center; }
        .lyrics-line.active { color: var(--lyrics-active-color); transform: scale(1.02); opacity: 1; text-shadow: 0 0 20px rgba(255, 255, 255, 0.3); }
        #desktop-lyrics-header { position: fixed; top: 0; right: 0; padding: 2rem; z-index: 110; }
        #lyrics-controls { position: relative; z-index: 102; width: 100%; padding: 0.75rem 4rem; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); }
        .vertical-slider-container { position: absolute; bottom: 100%; left: 50%; background-color: #2c2c2e; padding: 16px 12px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.6); opacity: 0; visibility: hidden; transform-origin: bottom center; transform: translateX(-50%) translateY(10px); transition: opacity 0.25s, visibility 0.25s, transform 0.25s cubic-bezier(0.4, 0.0, 0.2, 1); display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .control-wrapper.slider-active .vertical-slider-container { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
        .vertical-slider-bar { height: 100px; width: 6px; background-color: #4f4f52; border-radius: 3px; cursor: pointer; position: relative; }
        .vertical-slider-level { position: absolute; bottom: 0; width: 100%; background-color: var(--text-primary); border-radius: 3px; }
        .vertical-slider-bar:hover .vertical-slider-level { background: var(--accent-gradient); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        .play-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; font-size: 1.25rem; border-radius: inherit; }
        .group:hover .play-overlay { opacity: 1; }
        .song-row:hover { background-color: var(--bg-hover); }
        .song-row.playing { background-color: rgba(245, 89, 109, 0.1); border-left: 3px solid var(--accent-color); padding-left: calc(0.625rem - 3px); }
        .song-row.playing h3 { color: var(--accent-color); font-weight: 600; }
        .artist-hero { background-size: cover; background-position: center; position: relative; }
        .artist-hero::before { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, rgba(9,9,11,1) 10%, rgba(9,9,11,0.6) 50%, rgba(9,9,11,1) 90%); }
        .tab-button { padding: 0.75rem 1rem; border-bottom: 2px solid transparent; transition: all 0.2s ease-in-out; font-weight: 500; }
        .tab-button.active { color: var(--text-primary); border-bottom-color: var(--accent-color); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        #playlist-modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; backdrop-filter: blur(10px); }
        #playlist-modal.active { opacity: 1; visibility: visible; }
        #playlist-modal-content { background-color: var(--bg-elevated); border: 1px solid var(--border-color); border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: scale(0.95); transition: transform 0.3s; }
        #playlist-modal.active #playlist-modal-content { transform: scale(1); }
        #playlist-modal-body { overflow-y: auto; padding: 0 1.5rem 1.5rem; }
        #mobile-lyrics-header { display: none; }

        /* --- MOBILE-ONLY STYLES START --- */
        @keyframes professional-marquee {
            0%, 15% { transform: translateX(0); }
            85%, 100% { transform: translateX(var(--title-translate-x)); }
        }

        @media (max-width: 768px) {
            #app-wrapper { flex-direction: column; }
            #sidebar { width: 100%; height: auto; padding: 0.5rem 1rem; border-r: 0; border-bottom: 1px solid var(--border-color); flex-direction: row; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 0.5rem; }
            #sidebar > div:first-child { margin-bottom: 0; }
            #sidebar > .relative { order: 99; width: 100%; margin-top: 0; }
            #search-input { padding-top: 0.375rem; padding-bottom: 0.375rem; }
            #sidebar > nav { margin-top: 0; }
            #home-btn > span { display: none; }
            #home-btn { gap: 0; }
            #main-content { padding: 1.5rem; padding-bottom: calc(64px + env(safe-area-inset-bottom, 1rem) + 2rem); overflow-y: auto; touch-action: pan-y; -webkit-overflow-scrolling: touch; }
            #player-bar { display: none; }

            #mobile-mini-player { display: flex; position: fixed; bottom: 0; left: 0; right: 0; height: calc(64px + env(safe-area-inset-bottom)); padding-bottom: env(safe-area-inset-bottom); background-color: var(--bg-card); border-top: 1px solid var(--border-color); padding: 8px; align-items: center; gap: 12px; z-index: 1000; cursor: pointer; user-select: none; transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); pointer-events: auto; }
            body.full-player-active #mobile-mini-player { transform: translateY(100%); }
            #mobile-mini-player-art { width: 48px; height: 48px; border-radius: 4px; flex-shrink: 0; }
            #mobile-mini-player-info { flex-grow: 1; min-width: 0; }
            #mobile-mini-player-title { font-weight: 600; font-size: 14px; color: var(--text-primary); text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
            #mobile-mini-player-artist { font-size: 12px; color: var(--text-secondary); text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
            #mobile-mini-player-controls { display: flex; align-items: center; gap: 16px; padding-right: 8px; }
            #mobile-mini-player-play-pause { width: 44px; height: 44px; background-color: transparent; color: var(--text-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
            #mobile-mini-player-progress-bar { position: absolute; bottom: env(safe-area-inset-bottom, 0px); left: 8px; right: 8px; height: 3px; background-color: #4f4f52; }
            #mobile-mini-player-progress { height: 100%; background: var(--accent-gradient); width: 0%; }

            #mobile-full-player { position: fixed; inset: 0; z-index: 1050; background-color: var(--bg-primary); display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); padding: 0 1.5rem; }
            body.full-player-active #mobile-full-player { transform: translateY(0); }
            #mobile-full-player-bg { position: absolute; inset: 0; z-index: -1; }
            #mobile-full-player-bg-image { width: 100%; height: 100%; object-fit: cover; filter: blur(50px) brightness(0.4); transform: scale(1.1); }
            #mobile-full-player-header { display: flex; justify-content: space-between; align-items: center; padding-top: calc(1rem + env(safe-area-inset-top)); flex-shrink: 0; height: 56px; }
            .mobile-player-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; color: var(--text-primary); font-size: 20px; opacity: 1; }
            #mobile-full-player-minimize { font-size: 24px; }
            #mobile-full-player-more { font-size: 20px; }
            #mobile-full-player-content { flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: left; touch-action: pan-y; padding: 1rem 0; }
            #mobile-full-player-art { width: 100%; aspect-ratio: 1/1; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); user-select: none; -webkit-user-drag: none; margin-bottom: 2rem; }
            #mobile-full-player-info-wrapper { width: 100%; }
            #mobile-full-player-info { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
            #mobile-full-player-text { min-width: 0; flex-grow: 1; }
            #mobile-full-player-title-wrapper { overflow: hidden; width: 100%; }
            #mobile-full-player-title { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); display: inline-block; white-space: nowrap; will-change: transform; }
            #mobile-full-player-title.is-overflowing { animation: professional-marquee 12s linear 2s infinite; }
            #mobile-full-player-artist { font-size: 1.125rem; color: var(--text-secondary); margin-top: 0.25rem; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
            #mobile-full-player-footer { padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)); flex-shrink: 0; width: 100%; }
            .mobile-progress-wrapper { width: 100%; }
            #mobile-full-player-progress-bar { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #4f4f52; border-radius: 4px; outline: none; cursor: pointer; }
            #mobile-full-player-progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: var(--text-primary); border-radius: 50%; cursor: pointer; margin-top: -4px; }
            .mobile-time-labels { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-top: 0.75rem; }
            .mobile-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 1.25rem; }
            #mobile-full-player-play-pause { width: 72px; height: 72px; background-color: var(--text-primary); color: var(--bg-primary); border-radius: 50%; font-size: 28px; display: flex; align-items: center; justify-content: center; transform: scale(1); transition: transform 0.1s ease; }
            #mobile-full-player-play-pause:active { transform: scale(0.95); }
            .mobile-controls .mobile-player-btn { font-size: 28px; color: var(--text-primary); }
            .mobile-controls .mobile-player-btn.side-control { font-size: 22px; }
            .mobile-player-btn.control-active { color: var(--accent-color); }
            
            #mobile-more-options-modal { position: fixed; inset: 0; z-index: 1100; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
            #mobile-more-options-modal.active { opacity: 1; visibility: visible; }
            #mobile-more-options-content { position: absolute; bottom: 0; left: 0; right: 0; background-color: var(--bg-elevated); border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 1rem 1.5rem; padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
            #mobile-more-options-modal.active #mobile-more-options-content { transform: translateY(0); }
            .more-options-btn { background: var(--bg-hover); color: var(--text-primary); border: none; width: 100%; padding: 1rem; border-radius: 12px; font-size: 1rem; font-weight: 500; text-align: left; display: flex; align-items: center; gap: 1rem; }
            .more-options-btn i { width: 20px; text-align: center; }

            #mobile-pitch-modal { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--bg-elevated); border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 1200; padding: 1.5rem; padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)); box-shadow: 0 -10px 30px rgba(0,0,0,0.4); transform: translateY(100%); transition: transform 0.3s ease-out, visibility 0.3s; visibility: hidden; }
            #mobile-pitch-modal.active { transform: translateY(0); visibility: visible; }
            #mobile-pitch-modal .flex.justify-between.text-xs { padding: 0 5px; }
            
            #desktop-lyrics-header { display: none; }
            #mobile-lyrics-header { display: flex; }
            #lyrics-meta-column { display: none; }
            #lyrics-container-wrapper { width: 100%; padding-left: 0; }
            .lyrics-line { font-size: 1.8rem; text-align: center; }
            #mobile-lyrics-header { position: fixed; top: 0; left: 0; right: 0; padding: 0 1rem; height: calc(56px + env(safe-area-inset-top)); padding-top: env(safe-area-inset-top); background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent); z-index: 200; transform: translateY(0); opacity: 1; transition: transform 0.3s ease, opacity 0.3s ease; color: var(--text-primary); align-items: center; justify-content: space-between; gap: 1rem; }
            #lyrics-header-song-info { display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
            #lyrics-header-art { width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0; }
            #lyrics-header-text { overflow: hidden; text-align: left; }
            #lyrics-header-title-wrapper { overflow: hidden; white-space: nowrap; }
            #lyrics-header-title { display: inline-block; font-size: 1rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; will-change: transform; }
            #lyrics-header-title.is-overflowing { animation: professional-marquee 12s linear 2s infinite; }
            #lyrics-header-artist { font-size: 0.875rem; color: var(--text-secondary); text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
            #mobile-lyrics-view-close-btn { font-size: 2.5rem; line-height: 1; flex-shrink: 0; padding: 0.5rem; }
            #mobile-lyrics-header.hidden { transform: translateY(-100%); opacity: 0; pointer-events: none; }
            #lyrics-controls { position: fixed; bottom: 0; left: 0; right: 0; padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom)); background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 200; flex-direction: column; gap: 0.75rem; transform: translateY(0); opacity: 1; transition: transform 0.3s ease, opacity 0.3s ease; color: var(--text-primary); }
            #lyrics-controls.hidden { transform: translateY(100%); opacity: 0; pointer-events: none; }
            #lyrics-controls > div { width: 100% !important; justify-content: center; }
            #lyrics-controls > div:nth-child(2) { order: -1; margin-bottom: 0.5rem; }
            #lyrics-controls .player-button { color: var(--text-secondary); }
            #lyrics-controls .player-button.control-active { color: var(--accent-color); }
            #lyrics-content { padding-top: calc(env(safe-area-inset-top) + 72px); padding-bottom: calc(env(safe-area-inset-bottom) + 72px); transition: padding 0.3s ease; }
            body.lyrics-immersive #lyrics-content { padding-top: 40px; padding-bottom: 40px; }
            #search-tabs { display: block; white-space: nowrap; overflow-x: auto; }
        }
        /* --- MOBILE-ONLY STYLES END --- */

        @media (max-width: 640px) {
            .song-row > button[data-action='download-song'],
            .song-row > span.w-10 { display: none; }
            .lyrics-line { font-size: 1.6rem; }
            #lyrics-controls { padding: 1rem 1.5rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom)); }
        }
    </style>
</head>
<body class="text-music-text-primary">
    
    <div id="app-wrapper" class="flex h-screen">
        <aside id="sidebar" class="w-64 bg-black flex-shrink-0 p-6 flex flex-col border-r border-music-border z-20">
            <div class="flex items-center gap-3 text-music-accent mb-8">
                <i class="fa-solid fa-compact-disc fa-2x fa-spin-pulse" style="--fa-animation-duration: 5s;"></i>
                <span class="font-bold text-xl tracking-tighter">Srgam</span>
            </div>
            <div class="relative w-full">
                <i class="fa-solid fa-magnifying-glass h-4 w-4 absolute top-1/2 left-3 -translate-y-1/2 text-music-text-secondary"></i>
                <input id="search-input" type="search" placeholder="Artists, Songs, Albums" class="w-full bg-music-bg-elevated border border-music-border rounded-md py-2 pl-10 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-music-ring transition-all" />
                <button id="voice-search-btn" class="absolute top-1/2 right-3 -translate-y-1/2 text-music-text-secondary hover:text-white transition-colors" title="Search with your voice">
                    <i class="fa-solid fa-microphone"></i>
                </button>
            </div>
            <nav class="mt-6">
                <ul class="space-y-2">
                    <li><a href="#" id="home-btn" class="flex items-center gap-4 text-base font-medium hover:text-white transition-colors text-music-text-secondary px-3 py-2 rounded-md hover:bg-music-bg-hover"><i class="fa-solid fa-home w-5 text-center"></i><span>Home</span></a></li>
                </ul>
            </nav>
        </aside>
        <main id="main-content" class="flex-1 bg-music-bg-base p-8 overflow-y-auto">
            <div id="content-container"></div>
            <div id="suggestions-container" class="mt-12"></div>
        </main>
    </div>

    <!-- DESKTOP PLAYER BAR -->
    <footer id="player-bar" class="fixed bottom-0 left-0 w-full bg-music-bg-elevated border-t border-music-border h-[var(--player-height)] px-4 flex items-center justify-between gap-6 z-30">
        <div class="w-1/4 flex items-center justify-start gap-3 min-w-0">
            <img id="player-art" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Album Art" class="w-14 h-14 rounded-md bg-music-bg-hover" crossorigin="anonymous">
            <div class="min-w-0">
                <h4 id="player-title" class="font-medium truncate text-sm text-music-text-primary">Not Playing</h4>
                <div id="player-artist" class="text-xs text-music-text-secondary truncate">...</div>
            </div>
        </div>
        <div class="w-1/2 flex flex-col items-center justify-center gap-2 max-w-2xl">
             <div class="flex items-center justify-center gap-5">
                <button id="shuffle-btn" class="player-button text-music-text-secondary hover:text-white transition-colors" title="Shuffle Off"><i class="fa-solid fa-shuffle text-base"></i></button>
                <button id="prev-button" class="player-button text-music-text-secondary hover:text-white transition-colors"><i class="fa-solid fa-backward-step fa-lg"></i></button>
                <button id="play-pause-button" class="p-2 rounded-full w-10 h-10 flex items-center justify-center transition-all"><i id="play-pause-icon" class="fa-solid fa-play fa-lg ml-0.5"></i></button>
                <button id="next-button" class="player-button text-music-text-secondary hover:text-white transition-colors"><i class="fa-solid fa-forward-step fa-lg"></i></button>
                <button id="repeat-btn" class="player-button text-music-text-secondary hover:text-white transition-colors" title="Repeat Off"><i id="repeat-icon" class="fa-solid fa-repeat text-base"></i></button>
                <button id="autocontinue-btn" class="player-button text-music-text-secondary hover:text-white transition-colors" title="Auto-Continue On"><i class="fa-solid fa-infinity"></i></button>
            </div>
            <div class="w-full flex items-center gap-3 text-xs text-music-text-secondary control-slider-wrapper">
                <span id="current-time" class="w-10 text-right">0:00</span>
                <input id="progress-bar" type="range" min="0" max="100" value="0" class="control-slider flex-grow">
                <span id="total-time" class="w-10 text-left">0:00</span>
            </div>
        </div>
        <div class="w-1/4 flex items-center justify-end gap-3">
            <div id="pitch-control-wrapper" class="control-wrapper relative flex items-center">
                <button id="pitch-btn" class="player-button text-music-text-secondary hover:text-white transition-colors font-semibold text-xs w-16 text-center" title="Adjust Speed/Pitch"><span class="tracking-wider">SPEED</span></button>
                <div class="vertical-slider-container">
                    <span id="pitch-value" class="font-bold text-base text-white">1.00x</span>
                    <input id="pitch-slider" type="range" min="0.5" max="2.0" step="0.01" value="1">
                    <button id="pitch-reset-btn">Reset</button>
                </div>
            </div>
            <div id="volume-control-wrapper" class="control-wrapper relative flex items-center">
                <button id="volume-icon-btn" class="player-button text-music-text-secondary hover:text-white"><i id="volume-icon" class="fa-solid fa-volume-high"></i></button>
                <div class="vertical-slider-container">
                    <div id="volume-bar" class="vertical-slider-bar"><div id="volume-level" class="vertical-slider-level" style="height: 100%;"></div></div>
                </div>
            </div>
            <button id="view-playlist-btn" class="player-button text-music-text-secondary hover:text-white transition-colors" title="View Queue" disabled><i class="fa-solid fa-list-ol"></i></button>
            <button id="lyrics-btn" class="player-button text-music-text-secondary hover:text-white transition-colors" title="Show Lyrics" disabled><i class="fa-solid fa-microphone-lines"></i></button>
        </div>
    </footer>

    <!-- MOBILE PLAYER -->
    <div id="mobile-player-container">
        <div id="mobile-mini-player">
            <img id="mobile-mini-player-art" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Album Art">
            <div id="mobile-mini-player-info">
                <div id="mobile-mini-player-title">Not Playing</div>
                <div id="mobile-mini-player-artist">...</div>
            </div>
            <div id="mobile-mini-player-controls">
                <button id="mobile-mini-player-play-pause"><i id="mobile-mini-player-play-pause-icon" class="fa-solid fa-play"></i></button>
            </div>
            <div id="mobile-mini-player-progress-bar"><div id="mobile-mini-player-progress"></div></div>
        </div>

        <div id="mobile-full-player">
            <div id="mobile-full-player-bg"><img id="mobile-full-player-bg-image" src="" alt=""></div>
            <header id="mobile-full-player-header">
                <button id="mobile-full-player-minimize" class="mobile-player-btn"><i class="fa-solid fa-chevron-down"></i></button>
                <button id="mobile-full-player-more" class="mobile-player-btn"><i class="fa-solid fa-ellipsis-h"></i></button>
            </header>
            <main id="mobile-full-player-content">
                <img id="mobile-full-player-art" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Album Art">
                <div id="mobile-full-player-info-wrapper">
                    <div id="mobile-full-player-info">
                        <div id="mobile-full-player-text">
                            <div id="mobile-full-player-title-wrapper">
                                <h2 id="mobile-full-player-title">Song Title</h2>
                            </div>
                            <h3 id="mobile-full-player-artist">Artist Name</h3>
                        </div>
                    </div>
                    <div id="mobile-full-player-footer">
                        <div class="mobile-progress-wrapper">
                            <input id="mobile-full-player-progress-bar" type="range" min="0" max="100" value="0">
                            <div class="mobile-time-labels">
                                <span id="mobile-full-player-current-time">0:00</span>
                                <span id="mobile-full-player-total-time">0:00</span>
                            </div>
                        </div>
                        <div class="mobile-controls">
                            <button id="mobile-full-player-repeat" class="mobile-player-btn side-control"><i id="mobile-full-player-repeat-icon" class="fa-solid fa-repeat"></i></button>
                            <button id="mobile-full-player-prev" class="mobile-player-btn"><i class="fa-solid fa-backward-step"></i></button>
                            <button id="mobile-full-player-play-pause"><i id="mobile-full-player-play-pause-icon" class="fa-solid fa-play ml-1"></i></button>
                            <button id="mobile-full-player-next" class="mobile-player-btn"><i class="fa-solid fa-forward-step"></i></button>
                            <button id="mobile-full-player-playlist" class="mobile-player-btn side-control"><i class="fa-solid fa-list-ol"></i></button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div id="mobile-pitch-modal">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">Playback Speed</h3>
                <span id="mobile-pitch-value" class="font-bold text-base text-white bg-music-bg-hover px-3 py-1 rounded-md">1.00x</span>
            </div>
            <input id="mobile-pitch-slider" type="range" min="0.5" max="2.0" step="0.01" value="1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer" style="accent-color: var(--accent-color);">
            <div class="flex justify-between text-xs text-music-text-secondary mt-2">
                <span>0.5x</span>
                <span>1.0x</span>
                <span>2.0x</span>
            </div>
            <button id="mobile-pitch-reset-btn" class="w-full mt-4 bg-music-bg-hover text-white py-2.5 rounded-lg font-semibold">Reset Speed</button>
        </div>
        
        <div id="mobile-more-options-modal">
            <div id="mobile-more-options-content" class="space-y-3">
                 <button id="mobile-more-options-shuffle" class="more-options-btn"><i class="fa-solid fa-shuffle"></i><span>Shuffle</span></button>
                <button id="mobile-more-options-speed" class="more-options-btn"><i class="fa-solid fa-gauge-high"></i><span>Playback Speed</span></button>
                <button id="mobile-more-options-lyrics" class="more-options-btn"><i class="fa-solid fa-microphone-lines"></i><span>View Lyrics</span></button>
            </div>
        </div>
    </div>
    
    <div id="lyrics-view" class="h-screen w-screen fixed top-0 left-0 z-50">
        <div id="lyrics-background"><img id="lyrics-bg-image" src="" alt="" class="lyrics-bg-image" crossorigin="anonymous"/></div>
        
        <header id="desktop-lyrics-header">
            <button id="desktop-lyrics-view-close-btn" class="text-gray-400 hover:text-white transition-colors text-5xl leading-none">&times;</button>
        </header>
        
        <header id="mobile-lyrics-header">
            <div id="lyrics-header-song-info">
                <img id="lyrics-header-art" src="" alt="Album Art">
                <div id="lyrics-header-text">
                    <div id="lyrics-header-title-wrapper">
                        <span id="lyrics-header-title"></span>
                    </div>
                    <div id="lyrics-header-artist"></div>
                </div>
            </div>
            <button id="mobile-lyrics-view-close-btn" class="text-gray-400 hover:text-white transition-colors">&times;</button>
        </header>
        
        <div id="lyrics-content" class="gap-16">
            <div id="lyrics-meta-column">
                <img id="lyrics-view-art" src="" alt="Album Art" class="w-full max-w-sm rounded-lg shadow-2xl aspect-square" crossorigin="anonymous">
                <h2 id="lyrics-view-title" class="text-4xl font-bold mt-6">Song Title</h2>
                <div id="lyrics-view-artist" class="text-2xl text-music-text-secondary/90 mt-1">Artist Name</div>
                <div id="lyrics-view-meta" class="text-sm text-music-text-secondary/80 mt-4 space-y-1 font-normal"></div>
            </div>
            <div id="lyrics-container-wrapper">
                <div id="lyrics-container"><p class="lyrics-status">Lyrics will appear here.</p></div>
            </div>
        </div>

        <div id="lyrics-controls" class="flex items-center justify-between gap-6">
            <div class="w-1/4 flex items-center justify-center gap-5">
                <button id="lyrics-prev-button" class="player-button text-music-text-secondary hover:text-white transition-colors"><i class="fa-solid fa-backward-step fa-lg"></i></button>
                <button id="lyrics-play-pause-button" class="p-2 rounded-full w-10 h-10 flex items-center justify-center transition-all"><i id="lyrics-play-pause-icon" class="fa-solid fa-play fa-lg ml-0.5"></i></button>
                <button id="lyrics-next-button" class="player-button text-music-text-secondary hover:text-white transition-colors"><i class="fa-solid fa-forward-step fa-lg"></i></button>
            </div>
            <div class="w-1/2 flex-grow flex items-center gap-3 text-xs text-music-text-secondary control-slider-wrapper">
                <span id="lyrics-current-time" class="w-10 text-right">0:00</span>
                <input id="lyrics-progress-bar" type="range" min="0" max="100" value="0" class="control-slider flex-grow">
                <span id="lyrics-total-time" class="w-10 text-left">0:00</span>
            </div>
            <div class="w-1/4 flex items-center justify-center gap-4">
                <div id="lyrics-pitch-control-wrapper" class="control-wrapper relative flex items-center">
                    <button id="lyrics-pitch-btn" class="player-button text-music-text-secondary hover:text-white transition-colors font-semibold text-xs w-16 text-center" title="Adjust Speed/Pitch"><span class="tracking-wider">SPEED</span></button>
                    <div class="vertical-slider-container">
                        <span id="lyrics-pitch-value" class="font-bold text-base text-white">1.00x</span>
                        <input id="lyrics-pitch-slider" type="range" min="0.5" max="2.0" step="0.01" value="1">
                        <button id="lyrics-pitch-reset-btn">Reset</button>
                    </div>
                </div>
                <button id="lyrics-shuffle-btn" class="player-button text-music-text-secondary hover:text-white transition-colors" title="Shuffle Off"><i class="fa-solid fa-shuffle text-base"></i></button>
                <button id="lyrics-repeat-btn" class="player-button text-music-text-secondary hover:text-white transition-colors" title="Repeat Off"><i id="lyrics-repeat-icon" class="fa-solid fa-repeat text-base"></i></button>
                <button id="lyrics-autocontinue-btn" class="player-button text-music-text-secondary hover:text-white transition-colors" title="Auto-Continue On"><i class="fa-solid fa-infinity"></i></button>
                <div id="lyrics-volume-control-wrapper" class="control-wrapper relative flex items-center">
                    <button id="lyrics-volume-icon-btn" class="player-button text-music-text-secondary hover:text-white"><i id="lyrics-volume-icon" class="fa-solid fa-volume-high"></i></button>
                    <div class="vertical-slider-container">
                        <div id="lyrics-volume-bar" class="vertical-slider-bar"><div id="lyrics-volume-level" class="vertical-slider-level" style="height: 100%;"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="playlist-modal">
        <div id="playlist-modal-content">
            <div class="flex justify-between items-center p-4 border-b border-music-border">
                <h2 class="text-lg font-bold">Up Next</h2>
                <button id="playlist-modal-close-btn" class="text-music-text-secondary hover:text-white text-2xl">&times;</button>
            </div>
            <div id="playlist-modal-body"></div>
        </div>
    </div>

    <div id="toast-notification" class="fixed bottom-24 right-6 text-white py-3 px-6 rounded-lg shadow-lg text-sm font-semibold opacity-0 translate-y-4 transition-all duration-300 z-50" style="background: var(--accent-gradient);">
        Toast message
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dom = {
                mainContent: document.getElementById('main-content'),
                contentContainer: document.getElementById('content-container'),
                suggestionsContainer: document.getElementById('suggestions-container'),
                searchInput: document.getElementById('search-input'),
                homeBtn: document.getElementById('home-btn'),
                audioPlayer: document.getElementById('audio-player'),
                playerArt: document.getElementById('player-art'),
                playerTitle: document.getElementById('player-title'),
                playerArtist: document.getElementById('player-artist'),
                playPauseButton: document.getElementById('play-pause-button'),
                playPauseIcon: document.getElementById('play-pause-icon'),
                progressBar: document.getElementById('progress-bar'),
                currentTimeEl: document.getElementById('current-time'),
                totalTimeEl: document.getElementById('total-time'),
                lyricsBtn: document.getElementById('lyrics-btn'),
                lyricsView: document.getElementById('lyrics-view'),
                lyricsControls: document.getElementById('lyrics-controls'),
                lyricsBgImage: document.getElementById('lyrics-bg-image'),
                lyricsContainer: document.getElementById('lyrics-container'),
                lyricsViewArt: document.getElementById('lyrics-view-art'),
                lyricsViewTitle: document.getElementById('lyrics-view-title'),
                lyricsViewArtist: document.getElementById('lyrics-view-artist'),
                lyricsViewMeta: document.getElementById('lyrics-view-meta'),
                bodyEl: document.body,
                volumeControlWrapper: document.getElementById('volume-control-wrapper'),
                volumeBar: document.getElementById('volume-bar'),
                volumeLevel: document.getElementById('volume-level'),
                volumeIcon: document.getElementById('volume-icon'),
                prevButton: document.getElementById('prev-button'),
                nextButton: document.getElementById('next-button'),
                shuffleBtn: document.getElementById('shuffle-btn'),
                repeatBtn: document.getElementById('repeat-btn'),
                repeatIcon: document.getElementById('repeat-icon'),
                pitchControlWrapper: document.getElementById('pitch-control-wrapper'),
                pitchBtn: document.getElementById('pitch-btn'),
                pitchSlider: document.getElementById('pitch-slider'),
                pitchValue: document.getElementById('pitch-value'),
                pitchResetBtn: document.getElementById('pitch-reset-btn'),
                voiceSearchBtn: document.getElementById('voice-search-btn'),
                autocontinueBtn: document.getElementById('autocontinue-btn'),
                lyricsPlayPauseButton: document.getElementById('lyrics-play-pause-button'),
                lyricsPlayPauseIcon: document.getElementById('lyrics-play-pause-icon'),
                lyricsProgressBar: document.getElementById('lyrics-progress-bar'),
                lyricsCurrentTimeEl: document.getElementById('lyrics-current-time'),
                lyricsTotalTimeEl: document.getElementById('lyrics-total-time'),
                lyricsVolumeControlWrapper: document.getElementById('lyrics-volume-control-wrapper'),
                lyricsVolumeBar: document.getElementById('lyrics-volume-bar'),
                lyricsVolumeLevel: document.getElementById('lyrics-volume-level'),
                lyricsVolumeIcon: document.getElementById('lyrics-volume-icon'),
                lyricsPrevButton: document.getElementById('lyrics-prev-button'),
                lyricsNextButton: document.getElementById('lyrics-next-button'),
                lyricsShuffleBtn: document.getElementById('lyrics-shuffle-btn'),
                lyricsRepeatBtn: document.getElementById('lyrics-repeat-btn'),
                lyricsRepeatIcon: document.getElementById('lyrics-repeat-icon'),
                lyricsPitchControlWrapper: document.getElementById('lyrics-pitch-control-wrapper'),
                lyricsPitchBtn: document.getElementById('lyrics-pitch-btn'),
                lyricsPitchSlider: document.getElementById('lyrics-pitch-slider'),
                lyricsPitchValue: document.getElementById('lyrics-pitch-value'),
                lyricsPitchResetBtn: document.getElementById('lyrics-pitch-reset-btn'),
                lyricsAutocontinueBtn: document.getElementById('lyrics-autocontinue-btn'),
                viewPlaylistBtn: document.getElementById('view-playlist-btn'),
                playlistModal: document.getElementById('playlist-modal'),
                playlistModalContent: document.getElementById('playlist-modal-content'),
                playlistModalBody: document.getElementById('playlist-modal-body'),
                playlistModalCloseBtn: document.getElementById('playlist-modal-close-btn'),
                
                desktopLyricsViewCloseBtn: document.getElementById('desktop-lyrics-view-close-btn'),
                mobileLyricsViewCloseBtn: document.getElementById('mobile-lyrics-view-close-btn'),
                mobileLyricsHeader: document.getElementById('mobile-lyrics-header'),
                lyricsHeaderArt: document.getElementById('lyrics-header-art'),
                lyricsHeaderTitleWrapper: document.getElementById('lyrics-header-title-wrapper'),
                lyricsHeaderTitle: document.getElementById('lyrics-header-title'),
                lyricsHeaderArtist: document.getElementById('lyrics-header-artist'),

                mobileMiniPlayer: document.getElementById('mobile-mini-player'),
                mobileMiniPlayerArt: document.getElementById('mobile-mini-player-art'),
                mobileMiniPlayerTitle: document.getElementById('mobile-mini-player-title'),
                mobileMiniPlayerArtist: document.getElementById('mobile-mini-player-artist'),
                mobileMiniPlayerPlayPause: document.getElementById('mobile-mini-player-play-pause'),
                mobileMiniPlayerPlayPauseIcon: document.getElementById('mobile-mini-player-play-pause-icon'),
                mobileMiniPlayerProgress: document.getElementById('mobile-mini-player-progress'),
                mobileFullPlayer: document.getElementById('mobile-full-player'),
                mobileFullPlayerContent: document.getElementById('mobile-full-player-content'),
                mobileFullPlayerBgImage: document.getElementById('mobile-full-player-bg-image'),
                mobileFullPlayerMinimize: document.getElementById('mobile-full-player-minimize'),
                mobileFullPlayerMore: document.getElementById('mobile-full-player-more'),
                mobileFullPlayerLyrics: document.getElementById('mobile-more-options-lyrics'),
                mobileFullPlayerArt: document.getElementById('mobile-full-player-art'),
                mobileFullPlayerTitleWrapper: document.getElementById('mobile-full-player-title-wrapper'),
                mobileFullPlayerTitle: document.getElementById('mobile-full-player-title'),
                mobileFullPlayerArtist: document.getElementById('mobile-full-player-artist'),
                mobileFullPlayerProgressBar: document.getElementById('mobile-full-player-progress-bar'),
                mobileFullPlayerCurrentTime: document.getElementById('mobile-full-player-current-time'),
                mobileFullPlayerTotalTime: document.getElementById('mobile-full-player-total-time'),
                mobileFullPlayerShuffle: document.getElementById('mobile-more-options-shuffle'),
                mobileFullPlayerPrev: document.getElementById('mobile-full-player-prev'),
                mobileFullPlayerPlayPause: document.getElementById('mobile-full-player-play-pause'),
                mobileFullPlayerPlayPauseIcon: document.getElementById('mobile-full-player-play-pause-icon'),
                mobileFullPlayerNext: document.getElementById('mobile-full-player-next'),
                mobileFullPlayerRepeat: document.getElementById('mobile-full-player-repeat'),
                mobileFullPlayerRepeatIcon: document.getElementById('mobile-full-player-repeat-icon'),
                mobileFullPlayerPlaylist: document.getElementById('mobile-full-player-playlist'),
                mobileFullPlayerSpeed: document.getElementById('mobile-more-options-speed'),
                mobilePitchModal: document.getElementById('mobile-pitch-modal'),
                mobilePitchSlider: document.getElementById('mobile-pitch-slider'),
                mobilePitchValue: document.getElementById('mobile-pitch-value'),
                mobilePitchResetBtn: document.getElementById('mobile-pitch-reset-btn'),
                mobileMoreOptionsModal: document.getElementById('mobile-more-options-modal'),
            };

            const state = {
                currentSongData: null, currentLyrics: null, lastActiveLyricIndex: -1, lastSearchQuery: '', lastSearchData: null, currentPlaylist: [], debounceTimer: null, apiBase: 'https://jiosvn.vercel.app/api', isShuffleOn: false, repeatMode: 'none', searchPage: {}, 
                songViewMode: 'list', 
                currentSearchTab: 'songs',
                isListening: false,
                lyricsCache: new Map(),
                activeSongUIElements: [],
                autoContinue: true,
                recsEngine: { playedIds: new Set(), recommendationPlaylist: [], isRecommendationModeActive: false, seedSongId: null, sessionUsedRandomIndices: new Set(), },
                touchStartX: 0, touchEndX: 0, touchStartY: 0, touchEndY: 0,
            };

            const util = {
                b64EncodeUnicode: (str) => { return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function toSolidBytes(match, p1) { return String.fromCharCode('0x' + p1); })); },
                b64DecodeUnicode: (str) => { return decodeURIComponent(atob(str).split('').map(function(c) { return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2); }).join('')); },
                getBestImageUrl: (images, quality = '500x500') => { const placeholder = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; if (!images || images.length === 0) return placeholder; const targetQuality = images.find(img => img.quality === quality); let url = targetQuality ? targetQuality.url : images[0].url; url = url.replace('http:', 'https:'); if (url.includes('artist-default')) return placeholder; return url; },
                getBestAudioUrl: (urls) => { if (!urls || urls.length === 0) return null; const highQuality = urls.find(url => url.quality === '320kbps'); return (highQuality ? highQuality.url : urls[0].url).replace('http:', 'https:'); },
                formatTime: (seconds) => { const totalSeconds = Math.floor(seconds); if (isNaN(totalSeconds) || totalSeconds < 0) return '0:00'; const minutes = Math.floor(totalSeconds / 60); const secs = totalSeconds % 60; return `${minutes}:${secs < 10 ? '0' : ''}${secs}`; },
                formatNumber: (num) => { if (num === null || num === undefined) return 'N/A'; return new Intl.NumberFormat('en-US', { notation: 'compact', compactDisplay: 'short' }).format(num); },
                getArtistNames: (item) => { if (item?.artists?.primary && Array.isArray(item.artists.primary) && item.artists.primary.length > 0) { return item.artists.primary; } if (item?.primaryArtists) { if (typeof item.primaryArtists === 'string') return [{ name: item.primaryArtists, id: null }]; if (Array.isArray(item.primaryArtists)) return item.primaryArtists; } if (item?.more_info?.artistMap?.primary_artists) { return item.more_info.artistMap.primary_artists; } return []; },
                getAllArtistNames: (item) => { if (item?.artists?.all && Array.isArray(item.artists.all) && item.artists.all.length > 0) { return item.artists.all; } return util.getArtistNames(item); },
                decodeHtml: (html) => { if (!html) return ''; const textarea = document.createElement('textarea'); textarea.innerHTML = html; return textarea.value; },
                renderArtistLinks: (artists) => { if (!artists || artists.length === 0) return `<span>Unknown Artist</span>`; return artists.map(artist => `<a href="#" data-type="artist" data-id="${artist.id}" class="hover:underline">${util.decodeHtml(artist.name)}</a>`).join(', '); },
                getItemName: (item) => { return util.decodeHtml(item?.name || item?.title || 'Untitled') },
                getUniqueRandomRecIndex: () => { const min = 1; const max = 11; const rangeSize = max - min + 1; if (state.recsEngine.sessionUsedRandomIndices.size >= rangeSize) { state.recsEngine.sessionUsedRandomIndices.clear(); } let randomIndex; do { randomIndex = Math.floor(Math.random() * rangeSize) + min; } while (state.recsEngine.sessionUsedRandomIndices.has(randomIndex)); state.recsEngine.sessionUsedRandomIndices.add(randomIndex); return randomIndex; }
            };
            
            const api = { fetchFromApi: async (endpoint) => { try { const response = await fetch(`${state.apiBase}${endpoint}`); if (!response.ok) throw new Error(`API error: ${response.statusText}`); const json = await response.json(); if (json.success === false || (json.success && !json.data)) { console.warn(`API call to ${endpoint} returned no data or failed.`, json); return null; } return json; } catch (error) { console.error(`Failed to fetch from ${endpoint}:`, error); ui.renderError(`Could not fetch data. Please try again later.`); return null; } }, searchSongs: (query, page = 1) => api.fetchFromApi(`/search/songs?query=${encodeURIComponent(query)}&limit=50&page=${page}`), searchAlbums: (query, page = 1) => api.fetchFromApi(`/search/albums?query=${encodeURIComponent(query)}&limit=50&page=${page}`), searchArtists: (query, page = 1) => api.fetchFromApi(`/search/artists?query=${encodeURIComponent(query)}&limit=50&page=${page}`), getSong: (id) => api.fetchFromApi(`/songs/${id}`), getAlbum: (id) => api.fetchFromApi(`/albums?id=${id}`), getArtist: (id) => api.fetchFromApi(`/artists/${id}`), };
            const lrcApi = { searchLyrics: async (songTitle, artistName) => { const baseUrl = 'https://applelrcfetch-2.pages.dev/api/search'; const url = `${baseUrl}?song=${encodeURIComponent(songTitle)}&artist=${encodeURIComponent(artistName)}`; try { const response = await fetch(url); if (!response.ok) { const errData = await response.json().catch(() => null); throw new Error(errData?.error || `Lyrics API error: ${response.statusText}`); } return await response.json(); } catch (error) { console.error('Failed to fetch lyrics from LRC API:', error); return null; } } };
            const lastFmApi = { API_KEY: '8752a78487528da286961de1ec099657', BASE_URL: 'https://ws.audioscrobbler.com/2.0/', getSimilarTrack: async (artist, track, limit = 20) => { if (lastFmApi.API_KEY === 'YOUR_API_KEY_HERE') { console.error("Last.fm API key is not set."); ui.showToast("Recommendation engine disabled: Missing API Key."); return null; } const url = `${lastFmApi.BASE_URL}?method=track.getSimilar&artist=${encodeURIComponent(artist)}&track=${encodeURIComponent(track)}&api_key=${lastFmApi.API_KEY}&format=json&limit=${limit}`; try { const response = await fetch(url); if (!response.ok) throw new Error(`Last.fm API error: ${response.statusText}`); const data = await response.json(); if (data.error || !data.similartracks || !data.similartracks.track) { console.warn("Last.fm: No similar tracks found.", data); return null; } return data.similartracks.track; } catch (error) { console.error("Failed to fetch from Last.fm API:", error); return null; } } };
            
            const ui = {
                renderContent: (html) => { dom.contentContainer.innerHTML = html; dom.mainContent.scrollTop = 0; player.updateActiveSongIndicator(); },
                renderError: (message) => { ui.renderContent(`<div class="text-center p-8 bg-red-900/50 rounded-xl"><h2 class="text-2xl font-bold">Error</h2><p>${message}</p></div>`); },
                showSkeletonLoader: () => { ui.renderContent(`<div class="space-y-4"><div class="skeleton h-10 w-1/4"></div><div class="skeleton h-40 w-full"></div><div class="skeleton h-40 w-full"></div></div>`); },
                renderInitialView: () => { state.lastSearchData = null; ui.renderContent(`<div class="h-full flex flex-col items-center justify-center text-center p-8"><h1 class="text-8xl font-extrabold text-music-text-secondary/10 tracking-tighter">Srgam</h1><p class="text-music-text-secondary mt-2 text-lg max-w-md">Use the search bar to discover a world of music. Find your favorite songs, albums, and artists to begin your listening journey.</p></div>`); dom.suggestionsContainer.innerHTML = ''; },
                renderPaginatedSection: (category, data, renderer, query, page) => { if (!data || !data.results || data.results.length === 0) return '<p class="text-music-text-secondary text-center py-8">No results found in this category.</p>'; let html = renderer(data.results); html += ui.renderPaginationControls(data.total, page, query, category); return html; },
                renderPaginationControls: (total, page, query, category) => { const totalPages = Math.ceil(total / 50); if (totalPages <= 1) return ''; let html = `<div class="flex justify-center items-center gap-4 mt-8">`; html += `<button data-action="change-page" data-page="${page - 1}" data-query="${query}" data-category="${category}" class="px-4 py-2 rounded-md bg-music-bg-hover disabled:opacity-50 disabled:cursor-not-allowed" ${page === 1 ? 'disabled' : ''}>Previous</button>`; html += `<span class="font-medium text-sm">Page ${page} of ${totalPages}</span>`; html += `<button data-action="change-page" data-page="${page + 1}" data-query="${query}" data-category="${category}" class="px-4 py-2 rounded-md bg-music-bg-hover disabled:opacity-50 disabled:cursor-not-allowed" ${page >= totalPages ? 'disabled' : ''}>Next</button>`; html += `</div>`; return html; },
                renderSearchResults: (allData, query) => { state.lastSearchData = allData; state.lastSearchQuery = query; const { songData, albumData, artistData } = allData; const tabs = [ { id: 'songs', title: 'Songs', data: songData, renderer: state.songViewMode === 'list' ? ui.renderSongList : ui.renderSongGrid }, { id: 'albums', title: 'Albums', data: albumData, renderer: ui.renderGrid }, { id: 'artists', title: 'Artists', data: artistData, renderer: ui.renderGrid }, ]; const activeTabId = state.currentSearchTab; const tabButtonsHtml = tabs.map(tab => `<button class="tab-button text-music-text-secondary ${tab.id === activeTabId ? 'active' : ''}" data-tab="${tab.id}">${tab.title}</button>`).join(''); const viewToggleHtml = ` <div id="song-view-toggle-container" class="${activeTabId === 'songs' ? 'flex' : 'hidden'} items-center gap-1"> <button data-view="list" title="List View" class="p-2 rounded-md ${state.songViewMode === 'list' ? 'text-white bg-music-bg-hover' : 'text-music-text-secondary'} hover:text-white hover:bg-music-bg-hover"><i class="fas fa-list"></i></button> <button data-view="grid" title="Grid View" class="p-2 rounded-md ${state.songViewMode === 'grid' ? 'text-white bg-music-bg-hover' : 'text-music-text-secondary'} hover:text-white hover:bg-music-bg-hover"><i class="fas fa-grip"></i></button> </div>`; const headerHtml = `<div class="flex justify-between items-center border-b border-music-border mb-6"> <div id="search-tabs" class="flex items-center gap-2">${tabButtonsHtml}</div> ${viewToggleHtml} </div>`; const panelsHtml = tabs.map(tab => `<div id="panel-${tab.id}" class="tab-panel ${tab.id === activeTabId ? 'active' : ''}">${ui.renderPaginatedSection(tab.id, tab.data, tab.renderer, query, state.searchPage[tab.id] || 1)}</div>`).join(''); const finalHtml = `<div class="w-full">${headerHtml}<div id="search-panels">${panelsHtml}</div></div>`; ui.renderContent(finalHtml); },
                renderGrid: (items) => { if (!items) return ''; let html = `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7 gap-6">`; items.forEach(item => { const artistLinks = util.renderArtistLinks(util.getArtistNames(item)); const subtext = item.type === 'artist' ? 'Artist' : (artistLinks || item.year || ''); const imageClass = item.type === 'artist' ? 'rounded-full' : 'rounded-md'; const songJson = util.b64EncodeUnicode(JSON.stringify(item)); html += ` <div data-type="${item.type}" data-id="${item.id}" data-song-json="${songJson}" class="bg-music-bg-card border border-transparent hover:border-music-border rounded-lg p-4 transition-all cursor-pointer group"> <div class="relative mb-3"> <img src="${util.getBestImageUrl(item.image)}" alt="${util.getItemName(item)}" class="w-full ${imageClass} aspect-square object-cover bg-music-bg-base shadow-lg" crossorigin="anonymous"> ${item.type === 'song' ? '<div class="play-overlay rounded-md"><i class="fas fa-play"></i></div>' : ''} </div> <h3 class="font-semibold truncate text-sm text-music-text-primary">${util.getItemName(item)}</h3> <div class="text-xs text-music-text-secondary truncate">${subtext}</div> </div>`; }); return html + `</div>`; },
                renderSongGrid: (songs) => ui.renderGrid(songs),
                renderSongList: (songs, isNumbered = false) => { if (!songs || songs.length === 0) return ''; let html = `<div class="space-y-1">`; songs.forEach((song, index) => { const durationText = util.formatTime(song.duration); const artistLinks = util.renderArtistLinks(util.getArtistNames(song)); const songJson = util.b64EncodeUnicode(JSON.stringify(song)); html += ` <div class="song-row p-2.5 rounded-md transition-colors flex items-center gap-4 group relative" data-type="song" data-id="${song.id}" data-song-json="${songJson}"> <div class="relative flex-shrink-0 w-11 h-11 cursor-pointer"> <span class="absolute inset-0 flex items-center justify-center text-music-text-secondary group-hover:hidden font-medium text-sm">${isNumbered ? (index + 1) : ''}</span> <div class="absolute inset-0 hidden group-hover:flex items-center justify-center text-white bg-black/50 rounded-md"><i class="fas fa-play"></i></div> <img src="${util.getBestImageUrl(song.image, '150x150')}" alt="${util.getItemName(song)}" class="w-11 h-11 rounded-md object-cover bg-music-bg-base shadow-md" crossorigin="anonymous"> </div> <div class="flex-1 min-w-0"> <h3 class="font-medium truncate text-sm text-music-text-primary">${util.getItemName(song)}</h3> <div class="text-music-text-secondary text-xs truncate">${artistLinks}</div> </div> <span class="text-music-text-secondary text-xs w-10 text-right flex-shrink-0 pr-2">${durationText}</span> </div>`; }); return html + `</div>`; },
                renderAlbumPage: (album) => { let html = navigation.getBackButton(); html += `<div class="fade-in-up"><div class="flex flex-col md:flex-row gap-8 items-center md:items-start mb-10"><img src="${util.getBestImageUrl(album.data.image)}" alt="${util.getItemName(album.data)}" class="w-48 h-48 md:w-56 md:h-56 rounded-lg shadow-2xl object-cover flex-shrink-0" crossorigin="anonymous"><div class="mt-4 md:mt-2 text-center md:text-left"><p class="text-sm font-semibold uppercase tracking-wider text-music-text-secondary">Album</p><h2 class="text-4xl lg:text-5xl font-extrabold tracking-tight mt-1">${util.getItemName(album.data)}</h2><div class="text-lg text-music-text-primary/90 font-medium mt-3">${util.renderArtistLinks(util.getArtistNames(album.data))}</div><p class="text-sm text-music-text-secondary mt-1">${album.data.year}  ${album.data.songCount} Songs</p></div></div>${ui.renderSongList(album.data.songs, true)}</div>`; ui.renderContent(html); },
                renderArtistPage: (artist) => { const artistData = artist.data; let html = navigation.getBackButton(); html += `<div class="fade-in-up"><div class="artist-hero p-8 md:p-12 rounded-lg flex items-end min-h-[300px] md:min-h-[400px] mb-12" style="background-image: url('${util.getBestImageUrl(artistData.image)}')"><div class="relative z-10">${artistData.isVerified ? '<p class="font-bold uppercase text-xs tracking-widest">Verified Artist</p>' : ''}<h1 class="text-5xl md:text-7xl font-black tracking-tighter">${util.getItemName(artistData)}</h1><p class="mt-2 text-base text-music-text-secondary font-medium">${util.formatNumber(artistData.followerCount)} followers</p></div></div><h2 class="text-2xl font-bold mb-4">Top Songs</h2>${ui.renderSongList(artistData.topSongs)}<h2 class="text-2xl font-bold mt-8 mb-4">Top Albums</h2>${ui.renderGrid(artistData.topAlbums)}</div>`; ui.renderContent(html); },
                showToast: (message) => { const toast = document.getElementById('toast-notification'); if (!toast) return; toast.textContent = message; toast.style.opacity = '1'; toast.style.transform = 'translateY(0)'; setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(1rem)'; }, 3000); },
                updateTitleAnimation: (titleEl, wrapperEl) => {
                    if (!titleEl || !wrapperEl) return;
                    titleEl.classList.remove('is-overflowing');
                    requestAnimationFrame(() => {
                        const isOverflowing = titleEl.scrollWidth > wrapperEl.clientWidth;
                        if (isOverflowing) {
                            const overflowDistance = wrapperEl.clientWidth - titleEl.scrollWidth;
                            document.documentElement.style.setProperty('--title-translate-x', `${overflowDistance - 20}px`);
                            titleEl.classList.add('is-overflowing');
                        } else {
                            document.documentElement.style.setProperty('--title-translate-x', `0px`);
                        }
                    });
                },
            };

            const navigation = { goHome: () => { ui.renderInitialView(); dom.searchInput.value = ''; }, goBackToSearch: () => { if (state.lastSearchData) { ui.renderSearchResults(state.lastSearchData, state.lastSearchQuery); } else { navigation.goHome(); } }, getBackButton: () => { return state.lastSearchData ? `<div class="mb-8"><button data-action="go-back-to-search" class="text-music-text-secondary hover:text-white transition-colors font-medium text-sm"><i class="fa-solid fa-arrow-left mr-2"></i> Back to Search</button></div>` : ''; }, view: async (type, id) => { ui.showSkeletonLoader(); dom.suggestionsContainer.innerHTML = ''; let data; if (type === 'search') { state.searchPage = { songs: 1, albums: 1, artists: 1 }; const [songResponse, albumResponse, artistResponse] = await Promise.all([ api.searchSongs(id, 1), api.searchAlbums(id, 1), api.searchArtists(id, 1), ]); const allData = { songData: songResponse?.data, albumData: albumResponse?.data, artistData: artistResponse?.data }; state.currentSearchTab = allData.songData?.results?.length ? 'songs' : allData.albumData?.results?.length ? 'albums' : 'artists'; ui.renderSearchResults(allData, id); } else if (type === 'album') { data = await api.getAlbum(id); if (data?.data) { state.currentPlaylist = data.data.songs.sort((a,b) => (a.track || 0) - (b.track || 0)); ui.renderAlbumPage(data); } } else if (type === 'artist') { data = await api.getArtist(id); if (data?.data) { state.currentPlaylist = data.data.topSongs || []; ui.renderArtistPage(data); } } } };
            const recsEngine = { addPlayedSong: (songId) => { if (songId) state.recsEngine.playedIds.add(songId); }, buildRecommendationPlaylist: async (seedSong) => { if (!seedSong) return; if (state.recsEngine.seedSongId === seedSong.id) return; state.recsEngine.seedSongId = seedSong.id; state.recsEngine.isRecommendationModeActive = true; state.recsEngine.recommendationPlaylist = []; state.recsEngine.playedIds.clear(); state.recsEngine.sessionUsedRandomIndices.clear(); recsEngine.addPlayedSong(seedSong.id); const artistName = util.getArtistNames(seedSong)[0]?.name; const trackName = util.getItemName(seedSong); if (!artistName || !trackName) return; ui.showToast(`Finding songs similar to ${trackName}...`); const initialRecs = await lastFmApi.getSimilarTrack(artistName, trackName, 30); if (!initialRecs || initialRecs.length < 12) { ui.showToast("Not enough similar tracks found. Try another song."); state.currentPlaylist = [seedSong]; state.recsEngine.isRecommendationModeActive = false; return; } const seedIndex2 = util.getUniqueRandomRecIndex(); const seedIndex3 = util.getUniqueRandomRecIndex(); const seed1 = { artist: artistName, track: trackName }; const seed2 = { artist: initialRecs[seedIndex2].artist.name, track: initialRecs[seedIndex2].name }; const seed3 = { artist: initialRecs[seedIndex3].artist.name, track: initialRecs[seedIndex3].name }; ui.showToast(`Building deep playlist...`); const [recs1, recs2, recs3] = await Promise.all([ lastFmApi.getSimilarTrack(seed1.artist, seed1.track), lastFmApi.getSimilarTrack(seed2.artist, seed2.track), lastFmApi.getSimilarTrack(seed3.artist, seed3.track) ]); let combinedSimilarTracks = [].concat(recs1 || [], recs2 || [], recs3 || []); const uniqueTracks = Array.from(new Map(combinedSimilarTracks.map(track => [`${track.name.toLowerCase()}---${track.artist.name.toLowerCase()}`, track] )).values()); for (let i = uniqueTracks.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [uniqueTracks[i], uniqueTracks[j]] = [uniqueTracks[j], uniqueTracks[i]]; } const recommendationPromises = uniqueTracks.map(async (track) => { const query = `${track.artist.name} ${track.name}`; const searchResult = await api.searchSongs(query, 1); if (searchResult?.data?.results?.length > 0) { const foundSong = searchResult.data.results[0]; if (!state.recsEngine.playedIds.has(foundSong.id)) { recsEngine.addPlayedSong(foundSong.id); return foundSong; } } return null; }); const foundSongs = (await Promise.all(recommendationPromises)).filter(Boolean); state.recsEngine.recommendationPlaylist = [seedSong, ...foundSongs]; state.currentPlaylist = state.recsEngine.recommendationPlaylist; dom.viewPlaylistBtn.disabled = false; if (state.currentPlaylist.length > 1) { ui.showToast(`Deep playlist ready! ${state.currentPlaylist.length} songs added.`); } else { ui.showToast(`Couldn't find any playable similar tracks.`); } } };
            
            const player = {
                playSong: async (songId, playContext = {}) => {
                    try {
                        const songResult = await api.getSong(songId);
                        if (!songResult || !songResult.data || !songResult.data.length === 0) throw new Error('Could not fetch song details.');
                        const songData = songResult.data[0];
                        state.currentSongData = songData;
                        const audioUrl = util.getBestAudioUrl(songData.downloadUrl);
                        if (!audioUrl) { ui.showToast("Sorry, no streamable audio found for this song."); return; }
                        if (playContext.startRecommendation) { await recsEngine.buildRecommendationPlaylist(songData); } 
                        else { state.recsEngine.isRecommendationModeActive = false; state.recsEngine.seedSongId = null; dom.viewPlaylistBtn.disabled = state.currentPlaylist.length <= 1; }
                        recsEngine.addPlayedSong(songData.id);
                        dom.audioPlayer.src = audioUrl;
                        const savedPitch = localStorage.getItem('musicPlayerPitch');
                        if (savedPitch) { dom.audioPlayer.playbackRate = parseFloat(savedPitch); }
                        dom.audioPlayer.play();
                        player.updatePlayerUI(songData);
                        if (dom.bodyEl.classList.contains('lyrics-view-active') || dom.bodyEl.classList.contains('full-player-active')) {
                            player.fetchAndRenderLyrics(songData);
                        }
                    } catch (error) { console.error("Failed to play song:", error); ui.showToast("Error playing song."); }
                },
                playPrevSong: () => { 
                    if (!state.currentSongData) return;
                    const activePlaylist = state.recsEngine.isRecommendationModeActive ? state.recsEngine.recommendationPlaylist : state.currentPlaylist;
                    if (activePlaylist.length < 2) return; 
                    const currentIndex = activePlaylist.findIndex(song => song.id === state.currentSongData.id); 
                    if (currentIndex === -1) return;
                    const prevIndex = state.isShuffleOn ? Math.floor(Math.random() * activePlaylist.length) : (currentIndex === 0 ? activePlaylist.length - 1 : currentIndex - 1);
                    player.playSong(activePlaylist[prevIndex].id); 
                },
                playNextSong: () => {
                    if (!state.currentSongData) return 'ended';
                    const activePlaylist = state.recsEngine.isRecommendationModeActive ? state.recsEngine.recommendationPlaylist : state.currentPlaylist;
                    const currentIndex = activePlaylist.findIndex(song => song.id === state.currentSongData.id);
                    if (state.isShuffleOn) {
                        if (activePlaylist.length <= 1) return 'ended';
                        let nextIndex;
                        do { nextIndex = Math.floor(Math.random() * activePlaylist.length); } while (nextIndex === currentIndex);
                        player.playSong(activePlaylist[nextIndex].id);
                        return 'playing';
                    } else {
                        if (currentIndex > -1 && currentIndex < activePlaylist.length - 1) {
                            player.playSong(activePlaylist[currentIndex + 1].id);
                            return 'playing';
                        } else if (state.repeatMode === 'all') {
                            if (activePlaylist.length > 0) { player.playSong(activePlaylist[0].id); return 'playing'; }
                        }
                    }
                    return 'ended';
                },
                handleSongEnd: async () => {
                    if (state.repeatMode === 'one' && state.currentSongData) { dom.audioPlayer.currentTime = 0; dom.audioPlayer.play(); return; }
                    const status = player.playNextSong();
                    if (status === 'ended' && state.autoContinue && state.currentSongData) {
                        ui.showToast(`Playlist ended. Finding more songs like ${util.getItemName(state.currentSongData)}...`);
                        await recsEngine.buildRecommendationPlaylist(state.currentSongData);
                        if(state.currentPlaylist.length > 1) { player.playSong(state.currentPlaylist[1].id); }
                        return;
                    }
                    if (status === 'ended') { ui.showToast("Playlist finished."); }
                },
                updatePlayerUI: (songData) => {
                    const imageUrl = util.getBestImageUrl(songData.image);
                    const smallImageUrl = util.getBestImageUrl(songData.image, '150x150');
                    const artistLinks = util.renderArtistLinks(util.getArtistNames(songData));
                    const artistText = util.getArtistNames(songData).map(a => util.decodeHtml(a.name)).join(', ');
                    const songName = util.getItemName(songData);
                    
                    dom.playerArt.src = smallImageUrl;
                    dom.playerTitle.textContent = songName;
                    dom.playerArtist.innerHTML = artistLinks;
                    
                    dom.mobileMiniPlayerArt.src = smallImageUrl;
                    dom.mobileMiniPlayerTitle.textContent = songName;
                    dom.mobileMiniPlayerArtist.textContent = artistText;

                    dom.mobileFullPlayerArt.src = imageUrl;
                    dom.mobileFullPlayerBgImage.src = imageUrl;
                    dom.mobileFullPlayerTitle.textContent = songName;
                    dom.mobileFullPlayerArtist.textContent = artistText;

                    document.title = `${songName} - ${artistText}`;
                    
                    dom.lyricsHeaderArt.src = smallImageUrl;
                    dom.lyricsHeaderTitle.textContent = songName;
                    dom.lyricsHeaderArtist.textContent = artistText;
                    
                    dom.lyricsViewArt.src = imageUrl;
                    dom.lyricsViewTitle.textContent = songName;
                    dom.lyricsViewArtist.innerHTML = artistLinks;
                    dom.lyricsViewMeta.innerHTML = `<p><strong>Album:</strong> ${util.decodeHtml(songData.album?.name) || 'Single'}</p><p><strong>Year:</strong> ${songData.year || 'N/A'}</p><p><strong>Duration:</strong> ${util.formatTime(songData.duration)}</p>`;
                    dom.lyricsBgImage.classList.remove('loaded');
                    dom.lyricsBgImage.src = imageUrl;
                    dom.lyricsBgImage.onload = () => dom.lyricsBgImage.classList.add('loaded');
                    
                    dom.lyricsBtn.disabled = false;
                    
                    player.updateActiveSongIndicator();
                    ui.updateTitleAnimation(dom.mobileFullPlayerTitle, dom.mobileFullPlayerTitleWrapper);
                    ui.updateTitleAnimation(dom.lyricsHeaderTitle, dom.lyricsHeaderTitleWrapper);
                },
                updateActiveSongIndicator: () => {
                    document.querySelectorAll('.song-row.playing').forEach(el => el.classList.remove('playing'));
                    if (state.currentSongData) {
                        const songElements = document.querySelectorAll(`.song-row[data-id="${state.currentSongData.id}"]`);
                        songElements.forEach(el => el.classList.add('playing'));
                    }
                },
                renderCachedLyrics: (lyricsData) => {
                    state.currentLyrics = lyricsData;
                    if (lyricsData && lyricsData.length > 0) {
                        dom.lyricsContainer.innerHTML = lyricsData.map(line => `<p class="lyrics-line" data-time="${line.time}">${line.text || ''}</p>`).join('');
                    } else {
                        dom.lyricsContainer.innerHTML = `<p class="lyrics-status text-2xl font-semibold opacity-50">No synchronized lyrics found.</p>`;
                    }
                },
                fetchAndRenderLyrics: async (song) => {
                    if (state.lyricsCache.has(song.id)) { player.renderCachedLyrics(state.lyricsCache.get(song.id)); return; }
                    state.currentLyrics = null;
                    const songTitle = util.getItemName(song);
                    const primaryArtists = util.getArtistNames(song);
                    if (!songTitle || primaryArtists.length === 0) { dom.lyricsContainer.innerHTML = `<p class="lyrics-status text-2xl font-semibold opacity-50">Not enough info to find lyrics.</p>`; return; }
                    dom.lyricsContainer.innerHTML = `<p class="lyrics-status"><i class="fa-solid fa-spinner fa-spin"></i> Searching for lyrics...</p>`;
                    let lyricsFound = false;
                    for (const artist of primaryArtists) {
                        try {
                            const lrcResponse = await lrcApi.searchLyrics(songTitle, artist.name);
                            if (lrcResponse && lrcResponse.lyrics) {
                                const parsedLyrics = player.parseLrc(lrcResponse.lyrics);
                                state.lyricsCache.set(song.id, parsedLyrics);
                                player.renderCachedLyrics(parsedLyrics);
                                lyricsFound = true;
                                break; 
                            }
                        } catch (error) { console.warn(`Lyrics search failed for artist "${artist.name}":`, error); }
                    }
                    if (!lyricsFound) { state.lyricsCache.set(song.id, null); player.renderCachedLyrics(null); }
                },
                parseLrc: (lrcText) => { if (!lrcText) return []; const lines = lrcText.split('\n'); const parsed = []; const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/g; for (const line of lines) { const text = line.replace(timeRegex, '').trim(); let match; timeRegex.lastIndex = 0; if (text || line.includes('[')) { while ((match = timeRegex.exec(line)) !== null) { const time = parseInt(match[1], 10) * 60 + parseInt(match[2], 10) + parseInt(match[3].padEnd(3, '0'), 10) / 1000; parsed.push({ time, text: text || '' }); } } } return parsed.sort((a, b) => a.time - b.time); },
                updateSyncedLyrics: (currentTime) => { if (!state.currentLyrics || state.currentLyrics.length === 0) return; let activeIndex = -1; for (let i = state.currentLyrics.length - 1; i >= 0; i--) { if (currentTime >= state.currentLyrics[i].time - 0.2) { activeIndex = i; break; } } if (activeIndex !== state.lastActiveLyricIndex) { const lines = dom.lyricsContainer.querySelectorAll('.lyrics-line'); if (state.lastActiveLyricIndex !== -1 && lines[state.lastActiveLyricIndex]) lines[state.lastActiveLyricIndex].classList.remove('active'); if (activeIndex !== -1 && lines[activeIndex]) { lines[activeIndex].classList.add('active'); lines[activeIndex].scrollIntoView({ behavior: 'smooth', block: 'center' }); } state.lastActiveLyricIndex = activeIndex; } },
                setVolume: (volume) => { 
                    volume = Math.max(0, Math.min(1, volume)); 
                    dom.audioPlayer.volume = volume; 
                    localStorage.setItem('musicPlayerVolume', volume); 
                    const iconClass = volume > 0.5 ? 'fa-volume-high' : volume > 0 ? 'fa-volume-low' : 'fa-volume-xmark';
                    dom.volumeIcon.className = 'fa-solid ' + iconClass;
                    dom.lyricsVolumeIcon.className = 'fa-solid ' + iconClass;
                    dom.volumeLevel.style.height = `${volume * 100}%`; 
                    dom.lyricsVolumeLevel.style.height = `${volume * 100}%`; 
                },
                updateAllControlsUI: () => {
                    const isPaused = dom.audioPlayer.paused;
                    dom.playPauseIcon.className = `fa-solid ${isPaused ? 'fa-play fa-lg ml-0.5' : 'fa-pause fa-lg'}`;
                    dom.lyricsPlayPauseIcon.className = `fa-solid ${isPaused ? 'fa-play fa-lg ml-0.5' : 'fa-pause fa-lg'}`;
                    dom.mobileMiniPlayerPlayPauseIcon.className = `fa-solid ${isPaused ? 'fa-play' : 'fa-pause'}`;
                    dom.mobileFullPlayerPlayPauseIcon.className = `fa-solid ${isPaused ? 'fa-play ml-1' : 'fa-pause'}`;
                    
                    dom.shuffleBtn.classList.toggle('control-active', state.isShuffleOn);
                    dom.lyricsShuffleBtn.classList.toggle('control-active', state.isShuffleOn);
                    dom.mobileFullPlayerShuffle.classList.toggle('control-active', state.isShuffleOn);
                    
                    dom.repeatBtn.classList.toggle('control-active', state.repeatMode !== 'none');
                    dom.lyricsRepeatBtn.classList.toggle('control-active', state.repeatMode !== 'none');
                    dom.mobileFullPlayerRepeat.classList.toggle('control-active', state.repeatMode !== 'none');
                    const repeatIconClass = 'fa-solid ' + (state.repeatMode === 'one' ? 'fa-1' : 'fa-repeat');
                    dom.repeatIcon.className = repeatIconClass + ' text-base';
                    dom.lyricsRepeatIcon.className = repeatIconClass + ' text-base';
                    if(dom.mobileFullPlayerRepeatIcon) dom.mobileFullPlayerRepeatIcon.className = repeatIconClass;
                    
                    dom.autocontinueBtn.classList.toggle('control-active', state.autoContinue);
                    dom.lyricsAutocontinueBtn.classList.toggle('control-active', state.autoContinue);
                }
            };

            const voiceSearch = { recognition: null, init: () => { const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; if (!SpeechRecognition) { console.warn("Speech Recognition not supported by this browser."); dom.voiceSearchBtn.style.display = 'none'; return; } voiceSearch.recognition = new SpeechRecognition(); voiceSearch.recognition.continuous = false; voiceSearch.recognition.lang = 'en-US'; voiceSearch.recognition.interimResults = false; voiceSearch.recognition.maxAlternatives = 1; voiceSearch.recognition.onstart = () => { state.isListening = true; dom.voiceSearchBtn.classList.add('control-active'); dom.searchInput.placeholder = 'Listening...'; }; voiceSearch.recognition.onresult = (event) => { const transcript = event.results[0][0].transcript; dom.searchInput.value = transcript; navigation.view('search', transcript); }; voiceSearch.recognition.onspeechend = () => { voiceSearch.recognition.stop(); }; voiceSearch.recognition.onend = () => { state.isListening = false; dom.voiceSearchBtn.classList.remove('control-active'); dom.searchInput.placeholder = 'Artists, Songs, Albums'; }; voiceSearch.recognition.onerror = (event) => { console.error('Speech recognition error:', event.error); if (event.error !== 'no-speech') ui.showToast(`Voice search error: ${event.error}`); }; dom.voiceSearchBtn.addEventListener('click', () => { if (state.isListening) voiceSearch.recognition.stop(); else try { voiceSearch.recognition.start(); } catch (e) { console.error("Could not start recognition:", e); ui.showToast("Voice search could not be started."); } }); } };

            const mobilePlayer = {
                openFullPlayer: () => { if (state.currentSongData) { dom.bodyEl.classList.add('full-player-active'); ui.updateTitleAnimation(dom.mobileFullPlayerTitle, dom.mobileFullPlayerTitleWrapper); } },
                closeFullPlayer: () => { dom.bodyEl.classList.remove('full-player-active'); mobilePlayer.closePitchModal(); mobilePlayer.closeMoreOptionsMenu(); },
                openLyricsView: () => { if (state.currentSongData) { dom.bodyEl.classList.add('lyrics-view-active'); player.fetchAndRenderLyrics(state.currentSongData); mobilePlayer.closeFullPlayer(); showLyricsControls(); ui.updateTitleAnimation(dom.lyricsHeaderTitle, dom.lyricsHeaderTitleWrapper); } },
                togglePitchModal: () => { dom.mobilePitchModal.classList.toggle('active'); },
                closePitchModal: () => { dom.mobilePitchModal.classList.remove('active'); },
                toggleMoreOptionsMenu: () => { dom.mobileMoreOptionsModal.classList.toggle('active'); },
                closeMoreOptionsMenu: () => { dom.mobileMoreOptionsModal.classList.remove('active'); },
                handleTouchStart: (e) => { if(e.target.type === 'range') return; state.touchStartX = e.touches[0].clientX; state.touchStartY = e.touches[0].clientY; },
                handleTouchMove: (e) => { if(e.target.type === 'range') return; state.touchEndX = e.touches[0].clientX; state.touchEndY = e.touches[0].clientY; },
                handleTouchEnd: () => {
                    if(state.touchStartX === 0) return;
                    const dx = state.touchEndX - state.touchStartX;
                    const dy = state.touchEndY - state.touchStartY;
                    if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 50) { if (dy > 0) mobilePlayer.closeFullPlayer(); } 
                    else if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 50) { 
                        if (dx < -50) { mobilePlayer.openLyricsView(); }
                        else if (dx > 50) { player.playPrevSong(); }
                    }
                    state.touchStartX = 0; state.touchEndX = 0; state.touchStartY = 0; state.touchEndY = 0;
                }
            };
            
            let lyricsControlsTimeout;
            let isLyricsImmersive = false;

            function hideLyricsControls() {
                dom.mobileLyricsHeader.classList.add('hidden');
                dom.lyricsControls.classList.add('hidden');
                dom.bodyEl.classList.add('lyrics-immersive');
                isLyricsImmersive = true;
            }

            function showLyricsControls() {
                dom.mobileLyricsHeader.classList.remove('hidden');
                dom.lyricsControls.classList.remove('hidden');
                dom.bodyEl.classList.remove('lyrics-immersive');
                isLyricsImmersive = false;
                clearTimeout(lyricsControlsTimeout);
                lyricsControlsTimeout = setTimeout(hideLyricsControls, 10000);
            }

            function handleLyricsInteraction() { if (isLyricsImmersive) { showLyricsControls(); } }
            
            function handleLyricsTouch(e) {
                if (e.type === 'touchstart') {
                    state.touchStartX = e.touches[0].clientX;
                    state.touchStartY = e.touches[0].clientY;
                } else if (e.type === 'touchmove') {
                    state.touchEndX = e.touches[0].clientX;
                    state.touchEndY = e.touches[0].clientY;
                } else if (e.type === 'touchend') {
                    const dx = state.touchEndX - state.touchStartX;
                    const dy = state.touchEndY - state.touchStartY;
                    if (Math.abs(dx) > Math.abs(dy) && dx > 50) {
                        closeLyricsView();
                        mobilePlayer.openFullPlayer();
                    }
                    state.touchStartX = 0; state.touchEndX = 0; state.touchStartY = 0; state.touchEndY = 0;
                }
            }

            function init() {
                dom.homeBtn.addEventListener('click', (e) => { e.preventDefault(); navigation.goHome(); });
                
                const mainClickHandler = async (e) => {
                    const item = e.target.closest('[data-type][data-id]'); 
                    if (item) { 
                        e.preventDefault(); 
                        const { type, id } = item.dataset; 
                        if (!id || id === 'null') return; 
                        if (type === 'song') {
                            try {
                                if (item.closest('#playlist-modal')) { player.playSong(id, { startRecommendation: false }); dom.playlistModal.classList.remove('active'); return; }
                                const isFromSearch = !!item.closest('#search-panels');
                                const songJsonString = util.b64DecodeUnicode(item.dataset.songJson);
                                const songObject = JSON.parse(songJsonString);
                                if (isFromSearch) { player.playSong(id, { startRecommendation: true }); } 
                                else {
                                    const songListContainer = item.closest('.space-y-1, .grid');
                                    if (songListContainer) {
                                        const songElements = Array.from(songListContainer.querySelectorAll('[data-song-json]'));
                                        state.currentPlaylist = songElements.map(el => { try { return JSON.parse(util.b64DecodeUnicode(el.dataset.songJson)); } catch (err) { console.error("Failed to parse song JSON from playlist", err, el.dataset.songJson); return null; } }).filter(Boolean);
                                    } else { state.currentPlaylist = [songObject]; }
                                    player.playSong(id, { startRecommendation: false });
                                }
                            } catch (err) { console.error("Fatal error handling song click:", err); ui.showToast("Could not play the selected song."); }
                        } else { navigation.view(type, id); } 
                    }
                };

                dom.mainContent.addEventListener('click', async (e) => {
                    mainClickHandler(e);
                    const target = e.target;
                    const tabButton = target.closest('.tab-button');
                    if(tabButton) { e.preventDefault(); const tabId = tabButton.dataset.tab; state.currentSearchTab = tabId; document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active')); tabButton.classList.add('active'); document.getElementById(`panel-${tabId}`).classList.add('active'); const songViewToggle = document.getElementById('song-view-toggle-container'); if (songViewToggle) songViewToggle.classList.toggle('hidden', tabId !== 'songs'); return; }
                    const viewToggleBtn = target.closest('[data-view]');
                    if (viewToggleBtn) { e.preventDefault(); const newView = viewToggleBtn.dataset.view; if (state.songViewMode === newView) return; state.songViewMode = newView; ui.renderSearchResults(state.lastSearchData, state.lastSearchQuery); return; }
                    const pageBtn = target.closest('[data-action="change-page"]'); if (pageBtn) { e.preventDefault(); const { query, page, category } = pageBtn.dataset; state.searchPage[category] = parseInt(page); let apiCall; switch (category) { case 'songs': apiCall = api.searchSongs(query, page); break; case 'albums': apiCall = api.searchAlbums(query, page); break; case 'artists': apiCall = api.searchArtists(query, page); break; } const newData = await apiCall; const panel = document.getElementById(`panel-${category}`); if(panel && newData?.data) { const renderer = category === 'songs' ? (state.songViewMode === 'list' ? ui.renderSongList : ui.renderSongGrid) : ui.renderGrid; panel.innerHTML = ui.renderPaginatedSection(category, newData.data, renderer, query, parseInt(page)); player.updateActiveSongIndicator(); } return; }
                    const backBtn = target.closest('[data-action="go-back-to-search"]'); if (backBtn) { e.preventDefault(); navigation.goBackToSearch(); return; }
                });

                dom.searchInput.addEventListener('keyup', (e) => { clearTimeout(state.debounceTimer); const query = e.target.value.trim(); if (e.key === 'Enter' && query) { navigation.view('search', query); } else { state.debounceTimer = setTimeout(() => { if (query && query !== state.lastSearchQuery) { navigation.view('search', query); } else if (!query) { navigation.goHome(); } }, 400); } });
                
                dom.audioPlayer.addEventListener('play', player.updateAllControlsUI);
                dom.audioPlayer.addEventListener('pause', player.updateAllControlsUI);
                dom.audioPlayer.addEventListener('ended', player.handleSongEnd);
                dom.audioPlayer.addEventListener('timeupdate', () => { 
                    const { currentTime, duration } = dom.audioPlayer; 
                    if (isNaN(duration)) return; 
                    const progressPercent = (currentTime / duration) * 100;
                    const formattedCurrentTime = util.formatTime(currentTime);
                    dom.progressBar.value = currentTime; 
                    dom.currentTimeEl.textContent = formattedCurrentTime;
                    dom.progressBar.style.setProperty('--progress-percent', `${progressPercent}%`); 
                    dom.mobileMiniPlayerProgress.style.width = `${progressPercent}%`;
                    dom.mobileFullPlayerProgressBar.value = currentTime;
                    dom.mobileFullPlayerCurrentTime.textContent = formattedCurrentTime;
                    dom.lyricsProgressBar.value = currentTime;
                    dom.lyricsCurrentTimeEl.textContent = formattedCurrentTime;
                    dom.lyricsProgressBar.style.setProperty('--progress-percent', `${progressPercent}%`); 
                    if(dom.bodyEl.classList.contains('lyrics-view-active')) player.updateSyncedLyrics(currentTime); 
                });
                dom.audioPlayer.addEventListener('loadedmetadata', () => { 
                    const duration = dom.audioPlayer.duration;
                    const formattedTotalTime = util.formatTime(duration);
                    dom.progressBar.max = duration; 
                    dom.totalTimeEl.textContent = formattedTotalTime; 
                    dom.mobileFullPlayerProgressBar.max = duration;
                    dom.mobileFullPlayerTotalTime.textContent = formattedTotalTime;
                    dom.lyricsProgressBar.max = duration;
                    dom.lyricsTotalTimeEl.textContent = formattedTotalTime;
                });

                const togglePlayPause = () => dom.audioPlayer.paused ? dom.audioPlayer.play() : dom.audioPlayer.pause();
                const seek = (e) => dom.audioPlayer.currentTime = e.target.value;
                const toggleShuffle = () => { state.isShuffleOn = !state.isShuffleOn; player.updateAllControlsUI(); };
                const toggleRepeat = () => { const modes = ['none', 'all', 'one']; const currentModeIndex = modes.indexOf(state.repeatMode); state.repeatMode = modes[(currentModeIndex + 1) % modes.length]; player.updateAllControlsUI(); };
                const toggleAutoContinue = () => { state.autoContinue = !state.autoContinue; player.updateAllControlsUI(); };

                [dom.playPauseButton, dom.mobileMiniPlayerPlayPause, dom.mobileFullPlayerPlayPause, dom.lyricsPlayPauseButton].forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); togglePlayPause(); }));
                [dom.progressBar, dom.mobileFullPlayerProgressBar, dom.lyricsProgressBar].forEach(bar => bar.addEventListener('input', seek));
                [dom.nextButton, dom.mobileFullPlayerNext, dom.lyricsNextButton].forEach(btn => btn.addEventListener('click', player.playNextSong));
                [dom.prevButton, dom.mobileFullPlayerPrev, dom.lyricsPrevButton].forEach(btn => btn.addEventListener('click', player.playPrevSong));
                [dom.shuffleBtn, dom.mobileFullPlayerShuffle, dom.lyricsShuffleBtn].forEach(btn => btn.addEventListener('click', toggleShuffle));
                [dom.repeatBtn, dom.mobileFullPlayerRepeat, dom.lyricsRepeatBtn].forEach(btn => btn.addEventListener('click', toggleRepeat));
                [dom.autocontinueBtn, dom.lyricsAutocontinueBtn].forEach(btn => btn.addEventListener('click', toggleAutoContinue));
                
                dom.mobileMiniPlayer.addEventListener('click', mobilePlayer.openFullPlayer);
                dom.mobileFullPlayerMinimize.addEventListener('click', mobilePlayer.closeFullPlayer);
                dom.mobileFullPlayerMore.addEventListener('click', mobilePlayer.toggleMoreOptionsMenu);
                dom.mobileMoreOptionsModal.addEventListener('click', (e) => { if (e.target === dom.mobileMoreOptionsModal) mobilePlayer.closeMoreOptionsMenu(); });
                dom.mobileFullPlayerLyrics.addEventListener('click', () => { mobilePlayer.openLyricsView(); mobilePlayer.closeMoreOptionsMenu(); });
                dom.mobileFullPlayerSpeed.addEventListener('click', () => { mobilePlayer.togglePitchModal(); mobilePlayer.closeMoreOptionsMenu(); });
                dom.mobileFullPlayerPlaylist.addEventListener('click', () => { if (state.currentPlaylist.length > 0) { dom.playlistModalBody.innerHTML = ui.renderSongList(state.currentPlaylist, true); player.updateActiveSongIndicator(); dom.playlistModal.classList.add('active'); mobilePlayer.closeFullPlayer(); } else { ui.showToast("No playlist is active."); } });
                dom.mobileFullPlayerArt.addEventListener('touchstart', mobilePlayer.handleTouchStart, { passive: true });
                dom.mobileFullPlayerArt.addEventListener('touchmove', mobilePlayer.handleTouchMove, { passive: true });
                dom.mobileFullPlayerArt.addEventListener('touchend', mobilePlayer.handleTouchEnd, { passive: true });
                dom.mobileFullPlayer.addEventListener('click', (e) => { if (e.target === dom.mobileFullPlayer && dom.mobilePitchModal.classList.contains('active')) { mobilePlayer.closePitchModal(); } });

                dom.audioPlayer.preservesPitch = false;
                const handlePitchChange = (rate) => {
                    dom.audioPlayer.playbackRate = rate;
                    localStorage.setItem('musicPlayerPitch', rate);
                    const formattedRate = `${parseFloat(rate).toFixed(2)}x`;
                    [dom.pitchValue, dom.lyricsPitchValue, dom.mobilePitchValue].forEach(el => el.textContent = formattedRate);
                    const isActive = parseFloat(rate) !== 1.0;
                    [dom.pitchBtn, dom.lyricsPitchBtn].forEach(el => el.classList.toggle('control-active', isActive));
                };
                const resetPitch = () => { [dom.pitchSlider, dom.lyricsPitchSlider, dom.mobilePitchSlider].forEach(s => s.value = 1); handlePitchChange(1); };
                [dom.pitchSlider, dom.lyricsPitchSlider, dom.mobilePitchSlider].forEach(s => s.addEventListener('input', e => handlePitchChange(e.target.value)));
                [dom.pitchResetBtn, dom.lyricsPitchResetBtn, dom.mobilePitchResetBtn].forEach(btn => btn.addEventListener('click', resetPitch));

                const initSliderHover = (wrapper) => { if (!wrapper) return; let hideTimeout; wrapper.addEventListener('mouseenter', () => { clearTimeout(hideTimeout); wrapper.classList.add('slider-active'); }); wrapper.addEventListener('mouseleave', () => { hideTimeout = setTimeout(() => { wrapper.classList.remove('slider-active'); }, 300); }); };
                [dom.volumeControlWrapper, dom.pitchControlWrapper, dom.lyricsVolumeControlWrapper, dom.lyricsPitchControlWrapper].forEach(initSliderHover);
                const handleVolumeBarClick = (e, bar) => { const rect = bar.getBoundingClientRect(); player.setVolume((rect.bottom - e.clientY) / rect.height); };
                const toggleMute = () => player.setVolume(dom.audioPlayer.volume > 0 ? 0 : parseFloat(localStorage.getItem('musicPlayerVolume')) || 1);
                const handleWheel = (e) => { e.preventDefault(); let currentVolume = dom.audioPlayer.volume; if (e.deltaY < 0) { currentVolume = Math.min(1, currentVolume + 0.05); } else { currentVolume = Math.max(0, currentVolume - 0.05); } player.setVolume(currentVolume); };
                [dom.volumeBar, dom.lyricsVolumeBar].forEach(bar => bar.addEventListener('click', e => handleVolumeBarClick(e, bar)));
                [dom.volumeIcon.parentElement, dom.lyricsVolumeIcon.parentElement].forEach(el => el.addEventListener('click', (e) => { if(!e.target.closest('.vertical-slider-container')) toggleMute(); }));
                [dom.volumeControlWrapper, dom.lyricsVolumeControlWrapper].forEach(el => el.addEventListener('wheel', handleWheel, { passive: false }));
                
                const closeLyricsView = () => { dom.bodyEl.classList.remove('lyrics-view-active'); clearTimeout(lyricsControlsTimeout); };
                dom.lyricsBtn.addEventListener('click', () => { if (state.currentSongData) { dom.bodyEl.classList.add('lyrics-view-active'); player.fetchAndRenderLyrics(state.currentSongData); showLyricsControls(); ui.updateTitleAnimation(dom.lyricsHeaderTitle, dom.lyricsHeaderTitleWrapper); } });
                dom.desktopLyricsViewCloseBtn.addEventListener('click', closeLyricsView);
                dom.mobileLyricsViewCloseBtn.addEventListener('click', closeLyricsView);
                dom.lyricsContainer.addEventListener('click', (e) => { const line = e.target.closest('.lyrics-line[data-time]'); if (line) dom.audioPlayer.currentTime = parseFloat(line.dataset.time); });
                dom.lyricsView.addEventListener('click', handleLyricsInteraction);
                dom.lyricsView.addEventListener('mousemove', handleLyricsInteraction);
                dom.lyricsView.addEventListener('touchstart', handleLyricsTouch, { passive: true });
                dom.lyricsView.addEventListener('touchmove', handleLyricsTouch, { passive: true });
                dom.lyricsView.addEventListener('touchend', handleLyricsTouch, { passive: true });

                dom.viewPlaylistBtn.addEventListener('click', () => { if (state.currentPlaylist.length > 0) { dom.playlistModalBody.innerHTML = ui.renderSongList(state.currentPlaylist, true); player.updateActiveSongIndicator(); dom.playlistModal.classList.add('active'); } else { ui.showToast("No playlist is active."); } });
                dom.playlistModalCloseBtn.addEventListener('click', () => dom.playlistModal.classList.remove('active'));
                dom.playlistModal.addEventListener('click', (e) => { if (e.target === dom.playlistModal) dom.playlistModal.classList.remove('active'); });
                dom.playlistModalBody.addEventListener('click', mainClickHandler);

                let resizeDebounceTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeDebounceTimer);
                    resizeDebounceTimer = setTimeout(() => {
                        if (dom.bodyEl.classList.contains('lyrics-view-active')) ui.updateTitleAnimation(dom.lyricsHeaderTitle, dom.lyricsHeaderTitleWrapper);
                        if (dom.bodyEl.classList.contains('full-player-active')) ui.updateTitleAnimation(dom.mobileFullPlayerTitle, dom.mobileFullPlayerTitleWrapper);
                    }, 250);
                });

                ui.renderInitialView();
                voiceSearch.init();
                const savedVolume = localStorage.getItem('musicPlayerVolume');
                player.setVolume(savedVolume ? parseFloat(savedVolume) : 1);
                const savedPitch = localStorage.getItem('musicPlayerPitch');
                if (savedPitch) {
                    const pitch = parseFloat(savedPitch);
                    [dom.pitchSlider, dom.lyricsPitchSlider, dom.mobilePitchSlider].forEach(s => s.value = pitch);
                    handlePitchChange(pitch);
                }
                [dom.progressBar, dom.lyricsProgressBar].forEach(p => p.style.setProperty('--progress-color', 'var(--accent-color)'));
                player.updateAllControlsUI();
            }
            init();
        });
    </script>
</body>
</html>
