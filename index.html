<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.9.7/dist/ffmpeg.min.js"></script>
    <script> if (!crossOriginIsolated) SharedArrayBuffer = ArrayBuffer </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif']
                    },
                    colors: {
                        'music-bg-base': '#101010',
                        'music-bg-elevated': '#181818',
                        'music-bg-hover': '#242424',
                        'music-bg-tertiary': '#2a2a2a',
                        'music-border': '#303030',
                        'music-text-primary': '#ffffff',
                        'music-text-secondary': '#b3b3b3',
                        'music-accent': '#e60023',
                        'music-accent-hover': '#ff3355',
                    }
                }
            }
        }
    </script>
    <style>
        /* CSS is unchanged */
        :root {
            --player-height: 90px;
            --bg-primary: #101010;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --accent-color: #e60023;
            --accent-gradient: linear-gradient(135deg, #ff4d6d, #e60023);
            --skeleton-bg: #202020;
            --skeleton-highlight: #333333;
            --lyrics-text-color: rgba(255, 255, 255, 0.6);
            --lyrics-active-color: var(--text-primary);
        }
        body { font-family: 'Inter', -apple-system, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; background-color: var(--bg-primary); color: var(--text-primary); }
        body.lyrics-view-active #app-wrapper,
        body.lyrics-view-active #player-bar { display: none; }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; border: 3px solid var(--bg-primary); }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        html, body { height: 100%; overflow: hidden; }
        #main-content { padding-bottom: calc(var(--player-height) + 2rem); }
        .control-active { color: var(--accent-color) !important; }
        #play-pause-button { background: var(--accent-gradient); box-shadow: 0 6px 20px rgba(230, 0, 35, 0.35); }
        #play-pause-button:hover { filter: brightness(1.15); }
        .control-slider { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; cursor: pointer; height: 16px; }
        .control-slider::-webkit-slider-runnable-track { width: 100%; height: 5px; border-radius: 5px; background: linear-gradient(to right, var(--progress-color, #fff) 0%, var(--progress-color, #fff) var(--progress-percent, 0%), #4f4f52 var(--progress-percent, 0%)); transition: all 0.2s ease; }
        .control-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -5.5px; height: 16px; width: 16px; background-color: #fff; border-radius: 50%; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .control-slider:hover::-webkit-slider-thumb, .control-slider:active::-webkit-slider-thumb { opacity: 1; }
        #player-bar:hover .control-slider::-webkit-slider-runnable-track { background: linear-gradient(to right, var(--accent-color) 0%, var(--accent-color) var(--progress-percent, 0%), #4f4f52 var(--progress-percent, 0%)); }
        .skeleton { position: relative; overflow: hidden; background-color: var(--skeleton-bg); }
        .skeleton::before { content: ''; position: absolute; top: 0; left: -150%; width: 150%; height: 100%; background: linear-gradient(90deg, transparent, var(--skeleton-highlight), transparent); animation: skeleton-shine 2s infinite cubic-bezier(0.4, 0.0, 0.2, 1); }
        @keyframes skeleton-shine { 100% { left: 100%; } }
        .skeleton-artwork { width: 100%; padding-top: 100%; border-radius: 12px; margin-bottom: 12px; }
        .skeleton-text { height: 1em; border-radius: 4px; margin-bottom: 8px; }
        #lyrics-view { display: none; }
        body.lyrics-view-active #lyrics-view { display: flex; }
        #lyrics-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background-color: #000; }
        .lyrics-bg-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; filter: blur(80px) brightness(0.35); transform: scale(1.2); opacity: 0; transition: opacity 1s ease-in-out; }
        .lyrics-bg-image.loaded { opacity: 1; }
        #lyrics-content { position: relative; z-index: 101; width: 100%; height: 100%; display: flex; align-items: center; color: white; padding: 60px; }
        #lyrics-container-wrapper { height: 100%; display: flex; flex-direction: column; overflow: hidden; }
        #lyrics-container { flex-grow: 1; overflow-y: auto; text-align: left; scroll-behavior: smooth; scroll-padding: 38% 0; -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%); mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%); }
        #lyrics-container::before, #lyrics-container::after { content: ''; display: block; height: 38%; }
        .lyrics-line { font-size: 3rem; font-weight: 800; line-height: 1.4; margin: 0 0 0.8em 0; color: var(--lyrics-text-color); transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1); cursor: pointer; opacity: 0.6; transform-origin: left center; }
        .lyrics-line.active { color: var(--lyrics-active-color); transform: scale(1.05); opacity: 1; text-shadow: 0 0 30px rgba(255, 255, 255, 0.5); }
        #lyrics-header { position: fixed; top: 0; right: 0; padding: 2rem; z-index: 110; }
        .vertical-slider-container { position: absolute; bottom: 120%; left: 50%; background-color: #2c2c2e; padding: 16px 12px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.6); opacity: 0; visibility: hidden; transform-origin: bottom center; transform: translateX(-50%) translateY(10px); transition: all 0.25s cubic-bezier(0.4, 0.0, 0.2, 1); display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .control-wrapper:hover .vertical-slider-container { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
        .vertical-slider-bar { height: 100px; width: 6px; background-color: #4f4f52; border-radius: 3px; cursor: pointer; position: relative; }
        .vertical-slider-level { position: absolute; bottom: 0; width: 100%; background-color: var(--text-primary); border-radius: 3px; }
        .vertical-slider-bar:hover .vertical-slider-level { background-color: var(--accent-color); }
        #pitch-slider { writing-mode: vertical-lr; direction: rtl; width: 8px; height: 100px; }
        #pitch-reset-btn { font-size: 11px; font-weight: 500; color: var(--text-secondary); background: #3e3e40; padding: 3px 8px; border-radius: 6px; transition: all 0.2s ease; }
        #pitch-reset-btn:hover { color: var(--text-primary); background: #505052; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        .play-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; font-size: 1.25rem; border-radius: inherit; }
        .group:hover .play-overlay { opacity: 1; }
        .song-row:hover { background-color: var(--music-bg-hover); }
        .artist-hero { background-size: cover; background-position: center; position: relative; }
        .artist-hero::before { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, rgba(16,16,16,1) 10%, rgba(16,16,16,0.6) 50%, rgba(16,16,16,1) 90%); }
        .tab-button { padding: 0.75rem 1.5rem; border-bottom: 3px solid transparent; transition: all 0.2s ease-in-out; }
        .tab-button.active { color: var(--text-primary); border-bottom-color: var(--accent-color); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .view-toggle-button.active { background-color: var(--music-bg-tertiary); color: var(--text-primary); }
        @media (max-width: 768px) {
            #app-wrapper { flex-direction: column; }
            #sidebar { width: 100%; height: auto; padding: 1rem; border-r: 0; border-bottom: 1px solid var(--music-border); flex-direction: row; justify-content: space-between; align-items: center; }
            #main-content { padding: 1.5rem; padding-bottom: calc(var(--player-height) * 2.5); }
            #player-bar { flex-direction: column; height: auto; padding: 1rem; gap: 1rem; }
            #player-bar > div { width: 100% !important; }
            #player-bar .w-1\/3 { justify-content: center; }
            #player-bar .justify-end { justify-content: center; }
            .lyrics-line { font-size: 2rem; }
            #lyrics-content { flex-direction: column; text-align: center; }
            #lyrics-meta-column { width: 100%; align-items: center; margin-bottom: 2rem; }
            #lyrics-container-wrapper { width: 100%; }
            #search-tabs { display: block; white-space: nowrap; overflow-x: auto; }
        }
    </style>
</head>
<body class="text-music-text-primary">
    <!-- Body and UI structure is unchanged -->
    <div id="app-wrapper" class="flex h-screen">
        <aside id="sidebar" class="w-64 bg-black flex-shrink-0 p-8 flex flex-col border-r border-music-border/50 z-20">
            <div class="flex items-center gap-3 text-music-accent">
                <i class="fa-solid fa-compact-disc fa-2x fa-spin-pulse" style="--fa-animation-duration: 5s;"></i>
                <span class="font-bold text-2xl tracking-tighter">Music</span>
            </div>
            <div class="relative w-full mt-8">
                <i class="fa-solid fa-magnifying-glass h-4 w-4 absolute top-1/2 left-4 -translate-y-1/2 text-music-text-secondary"></i>
                <input id="search-input" type="search" placeholder="Artists, Songs, Albums" class="w-full bg-music-bg-elevated rounded-lg py-2.5 pl-11 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-music-accent transition-all" />
            </div>
            <nav class="mt-8">
                <ul class="space-y-4">
                    <li><a href="#" id="home-btn" class="flex items-center gap-4 text-lg font-semibold hover:text-white transition-colors text-music-text-secondary"><i class="fa-solid fa-home w-6 text-center"></i> Home</a></li>
                </ul>
            </nav>
        </aside>
        <main id="main-content" class="flex-1 bg-music-bg-base p-12 overflow-y-auto">
            <div id="content-container"></div>
            <div id="suggestions-container" class="mt-16"></div>
        </main>
    </div>
    <footer id="player-bar" class="fixed bottom-0 left-0 w-full bg-music-bg-elevated/70 backdrop-blur-2xl border-t border-music-border/50 h-[var(--player-height)] px-6 flex items-center justify-between gap-6 z-30 transition-colors duration-300">
        <div class="w-1/3 flex items-center gap-4 min-w-0">
            <img id="player-art" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Album Art" class="w-16 h-16 rounded-lg shadow-lg bg-music-bg-hover" crossorigin="anonymous">
            <div class="min-w-0">
                <h4 id="player-title" class="font-semibold truncate text-base text-music-text-primary">Not Playing</h4>
                <div id="player-artist" class="text-sm text-music-text-secondary truncate">...</div>
            </div>
        </div>
        <div class="w-1/3 flex flex-col items-center justify-center gap-1">
             <div class="flex items-center justify-center gap-6">
                <button id="shuffle-btn" class="player-button text-music-text-secondary hover:text-white transition-colors" title="Shuffle Off"><i class="fa-solid fa-shuffle fa-lg"></i></button>
                <button id="prev-button" class="player-button text-music-text-secondary hover:text-white transition-colors"><i class="fa-solid fa-backward-step fa-lg"></i></button>
                <button id="play-pause-button" class="p-2 rounded-full text-white w-14 h-14 flex items-center justify-center transition-all hover:scale-105"><i id="play-pause-icon" class="fa-solid fa-play fa-xl ml-1"></i></button>
                <button id="next-button" class="player-button text-music-text-secondary hover:text-white transition-colors"><i class="fa-solid fa-forward-step fa-lg"></i></button>
                <button id="repeat-btn" class="player-button text-music-text-secondary hover:text-white transition-colors" title="Repeat Off"><i id="repeat-icon" class="fa-solid fa-repeat fa-lg"></i></button>
            </div>
            <div class="w-full max-w-xl flex items-center gap-3 text-xs text-music-text-secondary mt-1">
                <span id="current-time" class="w-10 text-right">0:00</span>
                <input id="progress-bar" type="range" min="0" max="100" value="0" class="control-slider flex-grow">
                <span id="total-time" class="w-10 text-left">0:00</span>
            </div>
        </div>
        <div class="w-1/3 flex items-center justify-end gap-5">
            <button id="lyrics-btn" class="player-button text-music-text-secondary hover:text-white transition-colors" title="Show Lyrics" disabled><i class="fa-solid fa-microphone-lines fa-lg"></i></button>
            <div class="control-wrapper relative flex items-center">
                <button id="pitch-btn" class="player-button text-music-text-secondary hover:text-white transition-colors font-semibold text-sm w-16 text-center" title="Adjust Speed/Pitch"><span class="tracking-wider">SPEED</span></button>
                <div class="vertical-slider-container">
                    <span id="pitch-value" class="font-bold text-lg text-white">1.00x</span>
                    <input id="pitch-slider" type="range" min="0.5" max="2.0" step="0.01" value="1">
                    <button id="pitch-reset-btn">Reset</button>
                </div>
            </div>
            <div id="volume-control-wrapper" class="control-wrapper relative flex items-center">
                <button id="volume-icon-btn" class="player-button text-music-text-secondary hover:text-white"><i id="volume-icon" class="fa-solid fa-volume-high fa-lg"></i></button>
                <div class="vertical-slider-container">
                    <div id="volume-bar" class="vertical-slider-bar"><div id="volume-level" class="vertical-slider-level" style="height: 100%;"></div></div>
                </div>
            </div>
        </div>
    </footer>
    <div id="lyrics-view" class="h-screen w-screen fixed top-0 left-0 z-50">
        <div id="lyrics-background"><img id="lyrics-bg-image" src="" alt="" class="lyrics-bg-image" crossorigin="anonymous"/></div>
        <div id="lyrics-header"><button id="lyrics-view-close-btn" class="text-gray-400 hover:text-white transition-colors text-5xl leading-none">×</button></div>
        <div id="lyrics-content" class="gap-16">
            <div id="lyrics-meta-column" class="w-1/3 flex-shrink-0 flex flex-col items-start text-left">
                <img id="lyrics-view-art" src="" alt="Album Art" class="w-full max-w-sm rounded-2xl shadow-2xl aspect-square" crossorigin="anonymous">
                <h2 id="lyrics-view-title" class="text-5xl font-bold mt-8">Song Title</h2>
                <div id="lyrics-view-artist" class="text-3xl text-music-text-secondary/90 mt-2">Artist Name</div>
                <div id="lyrics-view-meta" class="text-md text-music-text-secondary/80 mt-6 space-y-1 font-medium"></div>
            </div>
            <div id="lyrics-container-wrapper" class="w-2/3 flex-grow">
                <div id="lyrics-container"><p class="lyrics-status">Lyrics will appear here.</p></div>
            </div>
        </div>
    </div>
    <audio id="audio-player" class="hidden"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { createFFmpeg, fetchFile } = FFmpeg;

            // All other code (DOM, state, util, api, ui, navigation) is the same as the previous correct version.
            const dom = { mainContent: document.getElementById('main-content'), contentContainer: document.getElementById('content-container'), suggestionsContainer: document.getElementById('suggestions-container'), searchInput: document.getElementById('search-input'), homeBtn: document.getElementById('home-btn'), audioPlayer: document.getElementById('audio-player'), playerArt: document.getElementById('player-art'), playerTitle: document.getElementById('player-title'), playerArtist: document.getElementById('player-artist'), playPauseButton: document.getElementById('play-pause-button'), playPauseIcon: document.getElementById('play-pause-icon'), progressBar: document.getElementById('progress-bar'), currentTimeEl: document.getElementById('current-time'), totalTimeEl: document.getElementById('total-time'), lyricsBtn: document.getElementById('lyrics-btn'), lyricsView: document.getElementById('lyrics-view'), lyricsViewCloseBtn: document.getElementById('lyrics-view-close-btn'), lyricsBgImage: document.getElementById('lyrics-bg-image'), lyricsContainer: document.getElementById('lyrics-container'), lyricsViewArt: document.getElementById('lyrics-view-art'), lyricsViewTitle: document.getElementById('lyrics-view-title'), lyricsViewArtist: document.getElementById('lyrics-view-artist'), lyricsViewMeta: document.getElementById('lyrics-view-meta'), bodyEl: document.body, volumeControlWrapper: document.getElementById('volume-control-wrapper'), volumeBar: document.getElementById('volume-bar'), volumeLevel: document.getElementById('volume-level'), volumeIcon: document.getElementById('volume-icon'), prevButton: document.getElementById('prev-button'), nextButton: document.getElementById('next-button'), shuffleBtn: document.getElementById('shuffle-btn'), repeatBtn: document.getElementById('repeat-btn'), repeatIcon: document.getElementById('repeat-icon'), pitchBtn: document.getElementById('pitch-btn'), pitchSlider: document.getElementById('pitch-slider'), pitchValue: document.getElementById('pitch-value'), pitchResetBtn: document.getElementById('pitch-reset-btn'), };
            const state = { currentSongData: null, currentLyrics: null, lastActiveLyricIndex: -1, lastSearchQuery: '', lastSearchData: null, currentPlaylist: [], debounceTimer: null, apiBase: 'https://jiosvn.vercel.app/api', isShuffleOn: false, repeatMode: 'none', searchPage: {}, songViewMode: 'list' };
            const util = { getBestImageUrl: (images, quality = '500x500') => { const placeholder = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; if (!images || images.length === 0) return placeholder; const targetQuality = images.find(img => img.quality === quality); let url = targetQuality ? targetQuality.url : images[0].url; url = url.replace('http:', 'https:'); if (url.includes('artist-default')) return placeholder; return url; }, getBestAudioUrl: (urls) => { if (!urls || urls.length === 0) return null; const highQuality = urls.find(url => url.quality === '320kbps'); return (highQuality ? highQuality.url : urls[0].url).replace('http:', 'https:'); }, formatTime: (seconds) => { const totalSeconds = Math.floor(seconds); if (isNaN(totalSeconds) || totalSeconds < 1) return ''; const minutes = Math.floor(totalSeconds / 60); const secs = totalSeconds % 60; return `${minutes}:${secs < 10 ? '0' : ''}${secs}`; }, formatNumber: (num) => { if (num === null || num === undefined) return 'N/A'; return new Intl.NumberFormat('en-US', { notation: 'compact', compactDisplay: 'short' }).format(num); }, getArtistNames: (item) => { if (item?.artists?.primary && Array.isArray(item.artists.primary) && item.artists.primary.length > 0) { return item.artists.primary; } if (item?.primaryArtists) { if (typeof item.primaryArtists === 'string') return [{ name: item.primaryArtists, id: null }]; if (Array.isArray(item.primaryArtists)) return item.primaryArtists; } if (item?.more_info?.artistMap?.primary_artists) { return item.more_info.artistMap.primary_artists; } return []; }, renderArtistLinks: (artists) => { if (!artists || artists.length === 0) return '<span>Unknown Artist</span>'; return artists.map(artist => `<a href="#" data-type="artist" data-id="${artist.id}" class="hover:underline">${artist.name}</a>`).join(', '); }, getItemName: (item) => { return item?.name || item?.title || 'Untitled'; }, cleanFileName: (filename) => { return filename.replace(/[<>:"/\\|?*]/g, '-'); } };
            const api = { fetchFromApi: async (endpoint) => { try { const response = await fetch(`${state.apiBase}${endpoint}`); if (!response.ok) throw new Error(`API error: ${response.statusText}`); const json = await response.json(); if (!json.success && !json.data) { console.warn(`API call to ${endpoint} returned no data.`); return null; } return json; } catch (error) { console.error(`Failed to fetch from ${endpoint}:`, error); ui.renderError(`Could not fetch data. Please try again later.`); return null; } }, searchSongs: (query, page = 1) => api.fetchFromApi(`/search/songs?query=${encodeURIComponent(query)}&limit=50&page=${page}`), searchAlbums: (query, page = 1) => api.fetchFromApi(`/search/albums?query=${encodeURIComponent(query)}&limit=50&page=${page}`), searchArtists: (query, page = 1) => api.fetchFromApi(`/search/artists?query=${encodeURIComponent(query)}&limit=50&page=${page}`), getSong: (id) => api.fetchFromApi(`/songs/${id}`), getAlbum: (id) => api.fetchFromApi(`/albums?id=${id}`), getArtist: (id) => api.fetchFromApi(`/artists/${id}`), getSuggestions: (id) => api.fetchFromApi(`/songs/${id}/suggestions`), getLyrics: (id) => api.fetchFromApi(`/lyrics?id=${id}`) };
            const ui = { renderContent: (html) => { dom.contentContainer.innerHTML = html; dom.mainContent.scrollTop = 0; }, renderError: (message) => { ui.renderContent(`<div class="text-center p-8 bg-red-900/50 rounded-xl"><h2 class="text-2xl font-bold">Error</h2><p>${message}</p></div>`); }, showSkeletonLoader: () => { ui.renderContent(`<div class="space-y-4"><div class="skeleton h-10 w-1/4"></div><div class="skeleton h-40 w-full"></div><div class="skeleton h-40 w-full"></div></div>`); }, renderInitialView: () => { state.lastSearchData = null; ui.renderContent(`<div class="h-full flex flex-col items-center justify-center text-center p-8"><h1 class="text-8xl font-extrabold text-music-text-secondary/10 tracking-tighter">Music</h1><p class="text-music-text-secondary mt-2 text-lg max-w-md">Use the search bar to discover a world of music. Find your favorite songs, albums, and artists to begin your listening journey.</p></div>`); dom.suggestionsContainer.innerHTML = ''; }, renderViewToggle: () => { return ` <div class="flex justify-end mb-4"> <div class="p-1 bg-music-bg-elevated rounded-lg flex items-center gap-1"> <button data-action="toggle-view" data-view="list" class="view-toggle-button px-3 py-1 rounded-md text-sm font-semibold text-music-text-secondary hover:text-white transition-colors ${state.songViewMode === 'list' ? 'active' : ''}" title="List View"><i class="fas fa-list"></i></button> <button data-action="toggle-view" data-view="grid" class="view-toggle-button px-3 py-1 rounded-md text-sm font-semibold text-music-text-secondary hover:text-white transition-colors ${state.songViewMode === 'grid' ? 'active' : ''}" title="Grid View"><i class="fas fa-grip"></i></button> </div> </div> `; }, renderPaginatedSection: (category, data, renderer, query, page) => { if (!data || !data.results || data.results.length === 0) return '<p class="text-music-text-secondary text-center py-8">No results found in this category.</p>'; let html = ''; if (category === 'songs') { html += ui.renderViewToggle(); html += state.songViewMode === 'grid' ? ui.renderGrid(data.results) : renderer(data.results); } else { html += renderer(data.results); } html += ui.renderPaginationControls(data.total, page, query, category); return html; }, renderPaginationControls: (total, page, query, category) => { const totalPages = Math.ceil(total / 50); if (totalPages <= 1) return ''; let html = `<div class="flex justify-center items-center gap-4 mt-6">`; html += `<button data-action="change-page" data-page="${page - 1}" data-query="${query}" data-category="${category}" class="px-4 py-2 rounded-lg bg-music-bg-hover disabled:opacity-50 disabled:cursor-not-allowed" ${page === 1 ? 'disabled' : ''}>Previous</button>`; html += `<span class="font-semibold">Page ${page} of ${totalPages}</span>`; html += `<button data-action="change-page" data-page="${page + 1}" data-query="${query}" data-category="${category}" class="px-4 py-2 rounded-lg bg-music-bg-hover disabled:opacity-50 disabled:cursor-not-allowed" ${page >= totalPages ? 'disabled' : ''}>Next</button>`; html += `</div>`; return html; }, renderSearchResults: (allData, query) => { state.lastSearchData = allData; state.lastSearchQuery = query; const { songData, albumData, artistData } = allData; const tabs = [ { id: 'songs', title: 'Songs', data: songData, renderer: ui.renderSongList }, { id: 'albums', title: 'Albums', data: albumData, renderer: ui.renderGrid }, { id: 'artists', title: 'Artists', data: artistData, renderer: ui.renderGrid }, ]; let html = `<div class="w-full"><div id="search-tabs" class="border-b border-music-border mb-6">${tabs.map((tab, index) => `<button class="tab-button font-semibold text-music-text-secondary ${index === 0 ? 'active' : ''}" data-tab="${tab.id}">${tab.title}</button>`).join('')}</div><div id="search-panels">${tabs.map((tab, index) => `<div id="panel-${tab.id}" class="tab-panel ${index === 0 ? 'active' : ''}">${ui.renderPaginatedSection(tab.id, tab.data, tab.renderer, query, state.searchPage[tab.id] || 1)}</div>`).join('')}</div></div>`; ui.renderContent(html); }, renderGrid: (items) => { if (!items) return ''; let html = `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-x-6 gap-y-8">`; items.forEach(item => { const artistLinks = util.renderArtistLinks(util.getArtistNames(item)); const subtext = item.type === 'song' ? artistLinks : (item.type === 'artist' ? 'Artist' : (artistLinks || item.year || '')); const imageClass = item.type === 'artist' ? 'rounded-full' : 'rounded-lg'; const name = util.getItemName(item); html += ` <div data-type="${item.type}" data-id="${item.id}" class="p-3 rounded-xl hover:bg-music-bg-hover transition-colors cursor-pointer group"> <div class="relative"> <img src="${util.getBestImageUrl(item.image)}" alt="${name}" class="w-full ${imageClass} mb-4 aspect-square object-cover bg-music-bg-base group-hover:scale-105 transition-transform duration-300 shadow-lg" crossorigin="anonymous"> <div class="play-overlay"><i class="fas fa-play"></i></div> </div> <h3 class="font-semibold truncate text-sm">${name}</h3> <div class="text-sm text-music-text-secondary truncate">${subtext}</div> </div>`; }); return html + `</div>`; }, renderSongList: (songs, isNumbered = false) => { if (!songs || songs.length === 0) return ''; let html = `<div class="space-y-1">`; songs.forEach((song, index) => { const durationText = util.formatTime(song.duration); const artistLinks = util.renderArtistLinks(util.getArtistNames(song)); const songJson = JSON.stringify(song).replace(/'/g, "'"); html += ` <div class="song-row p-2 rounded-lg transition-colors flex items-start md:items-center gap-4 group border-b border-transparent hover:border-music-border/20"> <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center text-music-text-secondary text-sm"> <span class="group-hover:hidden">${isNumbered ? (song.track || index + 1) : (index + 1)}</span> <button data-type="song" data-id="${song.id}" class="hidden group-hover:block text-white"><i class="fas fa-play fa-lg"></i></button> </div> <img data-type="song" data-id="${song.id}" src="${util.getBestImageUrl(song.image, '150x150')}" alt="${util.getItemName(song)}" class="w-12 h-12 rounded-md object-cover bg-music-bg-base shadow-md cursor-pointer flex-shrink-0" crossorigin="anonymous"> <div class="flex-1 min-w-0"> <h3 data-type="song" data-id="${song.id}" class="font-semibold text-music-text-primary cursor-pointer">${util.getItemName(song)}</h3> <div class="text-music-text-secondary text-sm md:truncate">${artistLinks}</div> </div> <button data-action="download-song" data-song-json='${songJson}' class="text-music-text-secondary hover:text-white px-3 transition-colors" title="Download Song"><i class="fas fa-download"></i></button> <span class="text-music-text-secondary text-sm w-10 text-right flex-shrink-0 pr-4 pt-1">${durationText}</span> </div>`; }); return html + `</div>`; }, renderAlbumPage: (album) => { let html = navigation.getBackButton(); html += `<div class="fade-in-up"><div class="flex flex-col md:flex-row gap-8 items-center md:items-start mb-10"><img src="${util.getBestImageUrl(album.data.image)}" alt="${album.data.name}" class="w-48 h-48 md:w-56 md:h-56 rounded-xl shadow-2xl object-cover flex-shrink-0" crossorigin="anonymous"><div class="mt-4 md:mt-2 text-center md:text-left"><p class="text-sm font-semibold uppercase tracking-wider text-music-text-secondary">Album</p><h2 class="text-4xl lg:text-6xl font-extrabold tracking-tight">${album.data.name}</h2><div class="text-xl text-music-text-primary/90 font-semibold mt-3">${util.renderArtistLinks(util.getArtistNames(album.data))}</div><p class="text-md text-music-text-secondary mt-1">${album.data.year} • ${album.data.songCount} Songs</p></div></div>${ui.renderSongList(album.data.songs, true)}</div>`; ui.renderContent(html); }, renderArtistPage: (artist) => { const artistData = artist.data; let html = navigation.getBackButton(); html += `<div class="fade-in-up"><div class="artist-hero p-8 md:p-12 rounded-2xl flex items-end min-h-[300px] md:min-h-[400px] mb-12" style="background-image: url('${util.getBestImageUrl(artistData.image)}')"><div class="relative z-10">${artistData.isVerified ? '<p class="font-bold uppercase text-sm">Verified Artist</p>' : ''}<h1 class="text-5xl md:text-8xl font-black tracking-tighter">${artistData.name}</h1><p class="mt-2 text-lg text-music-text-secondary font-medium">${util.formatNumber(artistData.followerCount)} followers</p></div></div>`; html += `<h2 class="text-3xl font-bold mb-6 mt-10">Top Songs</h2>`; html += ui.renderSongList(artistData.topSongs); html += `<h2 class="text-3xl font-bold mb-6 mt-10">Top Albums</h2>`; html += ui.renderGrid(artistData.topAlbums); html += `</div>`; ui.renderContent(html); }, renderSuggestions: (songs) => { if (!songs || !songs.data || songs.data.length === 0) { dom.suggestionsContainer.innerHTML = ''; return; } let html = `<h2 class="text-3xl font-bold mb-6">Similar Songs</h2>${ui.renderSongList(songs.data)}`; dom.suggestionsContainer.innerHTML = html; } };
            const navigation = { goHome: () => { ui.renderInitialView(); dom.searchInput.value = ''; }, goBackToSearch: () => { if (state.lastSearchData) { ui.renderSearchResults(state.lastSearchData, state.lastSearchQuery); } else { navigation.goHome(); } }, getBackButton: () => { return state.lastSearchData ? `<div class="mb-8"><button data-action="go-back-to-search" class="text-music-text-secondary hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-2"></i> Back to Search Results</button></div>` : ''; }, view: async (type, id) => { ui.showSkeletonLoader(); dom.suggestionsContainer.innerHTML = ''; let data; if (type === 'search') { state.searchPage = { songs: 1, albums: 1, artists: 1 }; const [songResponse, albumResponse, artistResponse] = await Promise.all([ api.searchSongs(id, 1), api.searchAlbums(id, 1), api.searchArtists(id, 1), ]); ui.renderSearchResults({ songData: songResponse?.data, albumData: albumResponse?.data, artistData: artistResponse?.data, }, id); } else if (type === 'album') { data = await api.getAlbum(id); if (data?.data) { state.currentPlaylist = data.data.songs.sort((a,b) => (a.track || 0) - (b.track || 0)); ui.renderAlbumPage(data); } } else if (type === 'artist') { data = await api.getArtist(id); if (data?.data) { state.currentPlaylist = data.data.topSongs || []; ui.renderArtistPage(data); } } } };

            const player = {
                playSong: async (songId) => { try { const songResult = await api.getSong(songId); if (!songResult || !songResult.data || songResult.data.length === 0) throw new Error('Could not fetch song details.'); const songData = songResult.data[0]; state.currentSongData = songData; const audioUrl = util.getBestAudioUrl(songData.downloadUrl); if (!audioUrl) { alert("Sorry, no streamable audio found for this song."); return; } dom.audioPlayer.src = audioUrl; dom.audioPlayer.play(); player.updatePlayerUI(songData); api.getSuggestions(songId).then(ui.renderSuggestions); } catch (error) { console.error("Failed to play song:", error); alert("Error playing song. Check the console for details."); } },
                
                downloadSong: async (song) => {
                    const button = document.querySelector(`button[data-song-json*='"id":"${song.id}"'] i`);
                    if (!button) return;

                    let ffmpeg;
                    try {
                        button.className = 'fas fa-spinner fa-spin';

                        // =========================================================================
                        // THE DEFINITIVE FIX (COMBINED)
                        // =========================================================================
                        // FIX #1: Force single-threaded core to avoid SharedArrayBuffer error.
                        // This prevents the library from trying to load the .wasm and .worker.js files.
                        ffmpeg = createFFmpeg({
                            log: true,
                            corePath: 'https://unpkg.com/@ffmpeg/core@0.8.5/dist/ffmpeg-core.js',
                        });

                        await ffmpeg.load();
                        
                        // FIX #2: Use a reliable CORS proxy for ALL external media fetches.
                        const corsProxy = 'https://cors.proxy.is/'; 
                        const audioUrl = util.getBestAudioUrl(song.downloadUrl);
                        const imageUrl = util.getBestImageUrl(song.image, '500x500');
                        if (!audioUrl) throw new Error("No high-quality audio URL found.");
                        
                        // The fetchFile utility from FFMPEG handles the request and returns a Uint8Array
                        const [audioData, imageData] = await Promise.all([
                            fetchFile(corsProxy + audioUrl),
                            fetchFile(corsProxy + imageUrl).catch(() => null) // Allow image fetch to fail gracefully
                        ]);
                        // =========================================================================


                        ffmpeg.FS('writeFile', 'input.m4a', audioData);
                        if (imageData) {
                            ffmpeg.FS('writeFile', 'cover.jpg', imageData);
                        }
                        
                        const title = util.getItemName(song);
                        const artists = util.getArtistNames(song).map(a => a.name).join('; ');
                        const album = song.album.name || 'Unknown Album';
                        const finalOutputFile = 'output.m4a';
                        
                        // Build the ffmpeg command array for better readability and safety
                        const command = ['-i', 'input.m4a'];
                        if (imageData) {
                            command.push('-i', 'cover.jpg', '-map', '0:a', '-map', '1:v');
                        }
                        command.push(
                            '-c:a', 'copy',
                            '-metadata', `title=${title}`,
                            '-metadata', `artist=${artists}`,
                            '-metadata', `album=${album}`
                        );
                        if (imageData) {
                            command.push('-disposition:v:0', 'attached_pic');
                        }
                        command.push(finalOutputFile);
                        
                        await ffmpeg.run(...command);

                        const data = ffmpeg.FS('readFile', finalOutputFile);
                        const taggedSongBlob = new Blob([data.buffer], { type: 'audio/mp4' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(taggedSongBlob);
                        
                        const artistString = util.getArtistNames(song).map(a => a.name).join(', ');
                        link.download = util.cleanFileName(`${artistString} - ${title}.m4a`);
                        
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(link.href);

                    } catch (error) {
                        console.error('Download failed:', error);
                        alert(`Download failed: ${error.message}`);
                    } finally {
                        if (button) button.className = 'fas fa-download';
                    }
                },
                
                // All other player and init functions remain the same as the previous version
                playPrevSong: () => { if (state.currentPlaylist.length < 2 || !state.currentSongData) return; const currentIndex = state.currentPlaylist.findIndex(song => song.id === state.currentSongData.id); if (currentIndex === -1) { if (state.currentPlaylist.length > 0) player.playSong(state.currentPlaylist[0].id); return; } const prevIndex = (currentIndex - 1 + state.currentPlaylist.length) % state.currentPlaylist.length; player.playSong(state.currentPlaylist[prevIndex].id); },
                playNextSong: () => { if (!state.currentSongData || state.currentPlaylist.length < 1) return; let nextIndex; const currentIndex = state.currentPlaylist.findIndex(song => song.id === state.currentSongData.id); if (state.isShuffleOn) { do { nextIndex = Math.floor(Math.random() * state.currentPlaylist.length); } while (state.currentPlaylist.length > 1 && nextIndex === currentIndex); } else { if (currentIndex === -1 || currentIndex === state.currentPlaylist.length - 1) { if (state.repeatMode === 'all') nextIndex = 0; else return; } else { nextIndex = currentIndex + 1; } } if (state.currentPlaylist[nextIndex]) { player.playSong(state.currentPlaylist[nextIndex].id); } },
                handleSongEnd: () => { if (state.repeatMode === 'one' && state.currentSongData) { player.playSong(state.currentSongData.id); } else { player.playNextSong(); } },
                updatePlayerUI: (songData) => { const imageUrl = util.getBestImageUrl(songData.image); const artistLinks = util.renderArtistLinks(util.getArtistNames(songData)); dom.playerArt.src = imageUrl; dom.playerTitle.textContent = util.getItemName(songData); dom.playerArtist.innerHTML = artistLinks; document.title = `${util.getItemName(songData)} - ${util.getArtistNames(songData).map(a=>a.name).join(', ')}`; dom.lyricsViewArt.src = imageUrl; dom.lyricsViewTitle.textContent = util.getItemName(songData); dom.lyricsViewArtist.innerHTML = artistLinks; dom.lyricsViewMeta.innerHTML = `<p><strong>Album:</strong> ${songData.album?.name || 'Single'}</p><p><strong>Year:</strong> ${songData.year || 'N/A'}</p><p><strong>Duration:</strong> ${util.formatTime(songData.duration)}</p>`; dom.lyricsBgImage.classList.remove('loaded'); dom.lyricsBgImage.src = imageUrl; dom.lyricsBgImage.onload = () => dom.lyricsBgImage.classList.add('loaded'); dom.lyricsBtn.disabled = !songData.hasLyrics; },
                fetchAndRenderLyrics: async (song) => { state.currentLyrics = null; if (!song.lyricsId) { dom.lyricsContainer.innerHTML = `<p class="lyrics-status text-2xl font-semibold opacity-50">Lyrics not available for this song.</p>`; return; } dom.lyricsContainer.innerHTML = `<p class="lyrics-status"><i class="fa-solid fa-spinner fa-spin"></i> Loading lyrics...</p>`; try { const lyricsResponse = await api.getLyrics(song.lyricsId); if (lyricsResponse?.data?.lyrics) { state.currentLyrics = player.parseLrc(lyricsResponse.data.lyrics); dom.lyricsContainer.innerHTML = state.currentLyrics.map(line => `<p class="lyrics-line" data-time="${line.time}">${line.text || '♪'}</p>`).join(''); } else { dom.lyricsContainer.innerHTML = `<p class="lyrics-status text-2xl font-semibold opacity-50">No synchronized lyrics found.</p>`; } } catch (error) { console.error("Lyrics fetch failed:", error); dom.lyricsContainer.innerHTML = `<p class="lyrics-status text-2xl font-semibold opacity-50">Could not load lyrics.</p>`; } },
                parseLrc: (lrcText) => { if (!lrcText) return []; const lines = lrcText.split('\n'); const parsed = []; const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/g; for (const line of lines) { const text = line.replace(timeRegex, '').trim(); let match; timeRegex.lastIndex = 0; if (text) { while ((match = timeRegex.exec(line)) !== null) { const time = parseInt(match[1], 10) * 60 + parseInt(match[2], 10) + parseInt(match[3].padEnd(3, '0'), 10) / 1000; parsed.push({ time, text }); } } } return parsed.sort((a, b) => a.time - b.time); },
                updateSyncedLyrics: (currentTime) => { if (!state.currentLyrics || state.currentLyrics.length === 0) return; let activeIndex = -1; for (let i = state.currentLyrics.length - 1; i >= 0; i--) { if (currentTime >= state.currentLyrics[i].time - 0.2) { activeIndex = i; break; } } if (activeIndex !== state.lastActiveLyricIndex) { const lines = dom.lyricsContainer.querySelectorAll('.lyrics-line'); if (state.lastActiveLyricIndex !== -1 && lines[state.lastActiveLyricIndex]) lines[state.lastActiveLyricIndex].classList.remove('active'); if (activeIndex !== -1 && lines[activeIndex]) { lines[activeIndex].classList.add('active'); lines[activeIndex].scrollIntoView({ behavior: 'smooth', block: 'center' }); } state.lastActiveLyricIndex = activeIndex; } },
                setVolume: (volume) => { volume = Math.max(0, Math.min(1, volume)); dom.audioPlayer.volume = volume; localStorage.setItem('musicPlayerVolume', volume); dom.volumeLevel.style.height = `${volume * 100}%`; dom.volumeIcon.className = 'fa-solid fa-lg ' + (volume > 0.5 ? 'fa-volume-high' : volume > 0 ? 'fa-volume-low' : 'fa-volume-xmark'); }
            };
            
            function init() {
                dom.homeBtn.addEventListener('click', (e) => { e.preventDefault(); navigation.goHome(); });
                dom.mainContent.addEventListener('click', async (e) => {
                    const target = e.target;
                    const tabButton = target.closest('.tab-button'); if(tabButton) { e.preventDefault(); document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active')); tabButton.classList.add('active'); document.getElementById(`panel-${tabButton.dataset.tab}`).classList.add('active'); return; }
                    const pageBtn = target.closest('[data-action="change-page"]'); if (pageBtn) { e.preventDefault(); const { query, page, category } = pageBtn.dataset; state.searchPage[category] = parseInt(page); let apiCall; switch (category) { case 'songs': apiCall = api.searchSongs(query, page); break; case 'albums': apiCall = api.searchAlbums(query, page); break; case 'artists': apiCall = api.searchArtists(query, page); break; } const newData = await apiCall; const panel = document.getElementById(`panel-${category}`); if(panel && newData?.data) { panel.innerHTML = ui.renderPaginatedSection(category, newData.data, category === 'songs' ? ui.renderSongList : ui.renderGrid, query, parseInt(page)); } return; }
                    const viewToggleBtn = target.closest('[data-action="toggle-view"]');
                    if (viewToggleBtn) {
                        e.preventDefault();
                        const view = viewToggleBtn.dataset.view;
                        if (state.songViewMode === view) return;
                        state.songViewMode = view;
                        const songPanel = document.getElementById('panel-songs');
                        if (songPanel && state.lastSearchData && state.lastSearchData.songData) {
                            songPanel.innerHTML = ui.renderPaginatedSection('songs', state.lastSearchData.songData, ui.renderSongList, state.lastSearchQuery, state.searchPage.songs || 1);
                        }
                        return;
                    }
                    const backBtn = target.closest('[data-action="go-back-to-search"]'); if (backBtn) { e.preventDefault(); navigation.goBackToSearch(); return; }
                    const downloadBtn = target.closest('[data-action="download-song"]'); if(downloadBtn) { e.preventDefault(); try { const songObject = JSON.parse(downloadBtn.dataset.songJson); player.downloadSong(songObject); } catch (err) { console.error("Failed to parse song JSON for download", err); alert("Could not download song due to a data error."); } return; }
                    const item = target.closest('[data-type][data-id]'); if (item) { e.preventDefault(); const { type, id } = item.dataset; if (!id || id === 'null') return; if (type === 'song') { player.playSong(id); } else { navigation.view(type, id); } }
                });
                dom.searchInput.addEventListener('keyup', (e) => { clearTimeout(state.debounceTimer); const query = e.target.value.trim(); if (e.key === 'Enter' && query) { navigation.view('search', query); } else { state.debounceTimer = setTimeout(() => { if (query && query !== state.lastSearchQuery) { navigation.view('search', query); } else if (!query) { navigation.goHome(); } }, 400); } });
                dom.playPauseButton.addEventListener('click', () => dom.audioPlayer.paused ? dom.audioPlayer.play() : dom.audioPlayer.pause());
                dom.audioPlayer.addEventListener('play', () => dom.playPauseIcon.className = 'fa-solid fa-pause fa-xl');
                dom.audioPlayer.addEventListener('pause', () => dom.playPauseIcon.className = 'fa-solid fa-play fa-xl ml-1');
                dom.audioPlayer.addEventListener('ended', player.handleSongEnd);
                dom.audioPlayer.addEventListener('timeupdate', () => { const { currentTime, duration } = dom.audioPlayer; if (isNaN(duration)) return; dom.progressBar.value = currentTime; dom.currentTimeEl.textContent = util.formatTime(currentTime) || '0:00'; dom.progressBar.style.setProperty('--progress-percent', `${(currentTime / duration) * 100}%`); if(dom.bodyEl.classList.contains('lyrics-view-active')) player.updateSyncedLyrics(currentTime); });
                dom.audioPlayer.addEventListener('loadedmetadata', () => { dom.progressBar.max = dom.audioPlayer.duration; dom.totalTimeEl.textContent = util.formatTime(dom.audioPlayer.duration); });
                dom.progressBar.addEventListener('input', (e) => dom.audioPlayer.currentTime = e.target.value);
                dom.nextButton.addEventListener('click', player.playNextSong);
                dom.prevButton.addEventListener('click', player.playPrevSong);
                dom.shuffleBtn.addEventListener('click', () => { state.isShuffleOn = !state.isShuffleOn; dom.shuffleBtn.classList.toggle('control-active', state.isShuffleOn); dom.shuffleBtn.title = state.isShuffleOn ? 'Shuffle On' : 'Shuffle Off'; });
                dom.repeatBtn.addEventListener('click', () => { const modes = ['none', 'all', 'one']; const currentModeIndex = modes.indexOf(state.repeatMode); state.repeatMode = modes[(currentModeIndex + 1) % modes.length]; dom.repeatBtn.classList.toggle('control-active', state.repeatMode !== 'none'); dom.repeatIcon.className = 'fa-solid fa-lg ' + (state.repeatMode === 'one' ? 'fa-1' : 'fa-repeat'); if (state.repeatMode === 'one') dom.repeatBtn.title = 'Repeat One'; else dom.repeatBtn.title = state.repeatMode === 'all' ? 'Repeat All' : 'Repeat Off'; });
                dom.audioPlayer.preservesPitch = false;
                dom.pitchSlider.addEventListener('input', e => { const rate = parseFloat(e.target.value); dom.audioPlayer.playbackRate = rate; dom.pitchValue.textContent = `${rate.toFixed(2)}x`; dom.pitchBtn.classList.toggle('control-active', rate !== 1.0); });
                dom.pitchResetBtn.addEventListener('click', () => { dom.pitchSlider.value = 1; dom.audioPlayer.playbackRate = 1; dom.pitchValue.textContent = '1.00x'; dom.pitchBtn.classList.remove('control-active'); });
                dom.volumeControlWrapper.addEventListener('wheel', e => { e.preventDefault(); let currentVolume = dom.audioPlayer.volume; if (e.deltaY < 0) { currentVolume = Math.min(1, currentVolume + 0.05); } else { currentVolume = Math.max(0, currentVolume - 0.05); } player.setVolume(currentVolume); }, { passive: false });
                dom.volumeBar.addEventListener('click', e => { const rect = dom.volumeBar.getBoundingClientRect(); player.setVolume((rect.bottom - e.clientY) / rect.height); });
                dom.volumeIcon.parentElement.addEventListener('click', (e) => { if(e.target.closest('.vertical-slider-container')) return; player.setVolume(dom.audioPlayer.volume > 0 ? 0 : parseFloat(localStorage.getItem('musicPlayerVolume')) || 1); });
                dom.lyricsBtn.addEventListener('click', () => { if (state.currentSongData) { dom.bodyEl.classList.add('lyrics-view-active'); player.fetchAndRenderLyrics(state.currentSongData); } });
                dom.lyricsViewCloseBtn.addEventListener('click', () => dom.bodyEl.classList.remove('lyrics-view-active'));
                dom.lyricsContainer.addEventListener('click', (e) => { const line = e.target.closest('.lyrics-line[data-time]'); if (line) dom.audioPlayer.currentTime = parseFloat(line.dataset.time); });
                ui.renderInitialView();
                const savedVolume = localStorage.getItem('musicPlayerVolume');
                player.setVolume(savedVolume ? parseFloat(savedVolume) : 1);
                dom.progressBar.style.setProperty('--progress-color', 'var(--text-primary)');
            }
            init();
        });
    </script>
</body>
</html>
